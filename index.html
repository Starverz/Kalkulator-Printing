<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PRINTING CALCULATOR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Link to Flowbite JS for drawer functionality -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />

  <style>
    /*
    ========================================
    Root Variables & Global Styles
    ========================================
    */
    /* Light Mode (default) variables */
    :root {
      --primary-color: #007BFF;
      --primary-hover: #0056b3;
      --secondary-color: #6c757d;
      --accent-color: #17a2b8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
      --content-bg: #ffffff;
      --border-color: #dee2e6;
      --text-primary: #212529;
      --text-secondary: #495057;
      --border-radius: 8px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Dark Mode variables - This applies the dark theme globally */
    html.dark {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --secondary-color: #4b5563;
      --accent-color: #2dd4bf;
      --success-color: #22c55e;
      --danger-color: #ef4444;
      --light-bg: #111827;
      --content-bg: #1f2937;
      --border-color: #4b5563;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* --- Light Mode Islands in Dark Mode --- */
    /* This rule resets all color variables for specific components back to their
   original light-mode values, even when the rest of the page is dark. */
    html.dark .invoice,
    html.dark .calculator-container,
    html.dark .sticker-editor-wrapper .container,
    html.dark #currencyModal>div {
      color: #212529;
      /* Re-apply the primary text color to all children */
      --primary-color: #007BFF;
      --primary-hover: #0056b3;
      --secondary-color: #6c757d;
      --accent-color: #17a2b8;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
      --content-bg: #ffffff;
      --border-color: #dee2e6;
      --text-primary: #212529;
      --text-secondary: #495057;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* --- START: NEW DARK MODE STYLES FOR SETTINGS --- */
    /* This new block ONLY applies when dark mode is active */
    html.dark .settings-panel {
      background-color: var(--content-bg);
      border-color: var(--border-color);
    }

    html.dark .settings-panel h4,
    html.dark .settings-panel label {
      color: var(--text-primary);
    }

    html.dark .settings-panel p {
      color: var(--text-secondary);
    }

    html.dark .settings-panel input[type="number"],
    html.dark .settings-panel input[type="text"],
    html.dark .settings-panel select {
      background-color: #374151;
      /* Tailwind gray-700 */
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    html.dark .settings-panel .modern-checkbox-grid .checkbox-group {
      background-color: #374151;
      border-color: var(--border-color);
    }

    html.dark .settings-panel .modern-checkbox-grid label::before {
      background-color: #4b5563;
      /* A slightly lighter gray for the box */
      border-color: var(--border-color);
    }

    html.dark .settings-panel .modern-checkbox-grid input[type="checkbox"]:checked+label::before {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    html.dark .settings-panel .btn-secondary {
      background-color: #4b5563;
      /* Tailwind gray-600 */
    }

    /* --- END: NEW DARK MODE STYLES FOR SETTINGS --- */
    /* --- START: Settings Tab Glow Effect (Dark Mode) --- */
    /* Add a smooth transition for all tab buttons */
    html.dark #settingsTab button {
      transition: all 0.3s ease;
    }

    /* Style for the ACTIVE tab button in dark mode */
    html.dark #settingsTab button.border-blue-600 {
      background-image: radial-gradient(ellipse at top, rgba(99, 102, 241, 0.2), transparent 80%);
      border-color: #60a5fa;
      /* A brighter blue for the border */
      box-shadow: 0 4px 20px -5px rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
      /* Optional: lift the tab slightly */
    }

    /* --- END: Settings Tab Glow Effect (Dark Mode) --- */
    /* Additional fix for inputs and textareas inside the light islands */
    html.dark .material-card input,
    html.dark .calculator-panel input,
    html.dark .invoice input,
    html.dark .calculator-container input,
    html.dark .sticker-editor-wrapper .container input,
    html.dark #currencyModal>div input,
    html.dark .material-card select,
    html.dark .calculator-panel select,
    html.dark .invoice select,
    html.dark .calculator-container select,
    html.dark .sticker-editor-wrapper .container select,
    html.dark #currencyModal>div select,
    html.dark .material-card textarea,
    html.dark .calculator-panel textarea,
    html.dark .invoice textarea,
    html.dark .calculator-container textarea,
    html.dark .sticker-editor-wrapper .container textarea,
    html.dark #currencyModal>div textarea {
      background-color: #ffffff;
      color: #212529;
      border-color: #dee2e6;
    }

    html.dark .settings-panel .settings-table th {
      color: var(--text-primary);
      /* Use the theme's primary text color for dark mode */
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--light-bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    /*
========================================
Home Page Grid Styles
========================================
*/
    .home-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      max-width: 1100px;
      margin: 24px auto 0;
    }

    .home-card {
      position: relative;
      padding: 24px;
      border-radius: 16px;
      color: white;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      text-align: center;
    }

    .home-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      z-index: 1;
    }

    .home-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .home-card-icon {
      font-size: 48px;
      margin-bottom: 16px;
      position: relative;
      z-index: 2;
    }

    .home-card-title {
      font-size: 18px;
      font-weight: 600;
      position: relative;
      z-index: 2;
    }

    /* Responsive adjustments for the home grid */
    @media (max-width: 1024px) {
      .home-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .home-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /*
    ========================================
    Main Content Area
    ========================================
    */
    .content {
      padding: 32px;
      overflow-y: auto;
    }

    .content h2 {
      font-size: 28px;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .content p {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    /*
    ========================================
    Printing Calculator Specific Styles
    ========================================
    */
    .material-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .material-card {
      background: var(--content-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .material-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    /* --- Dark Mode Material Card Styles --- */
    html.dark .material-card .material-info strong,
    html.dark .material-card .agent-toggle {
      /* Ensure text inside the card uses dark theme text colors */
      color: var(--text-primary);
    }

    html.dark .material-card .material-info span {
      /* Keep the price in the theme's primary accent color */
      color: var(--primary-color);
    }

    html.dark .material-card .agent-toggle {
      background: #374151;
      /* A neutral dark gray */
      color: var(--text-secondary);
      border-top-color: var(--border-color);
    }

    html.dark .material-card .agent-toggle:hover {
      background: #4b5563;
      /* Lighter gray on hover */
    }

    html.dark .material-card .agent-toggle.agent-active {
      background: var(--success-color);
      color: #ffffff;
      /* White text on green background */
    }

    html.dark .material-card .agent-toggle.agent-active:hover {
      background: #16a34a;
      /* A slightly darker green for hover */
    }

    /* Glow effect for agent-active cards in dark mode */
    html.dark .material-card:has(.agent-toggle.agent-active) {
      border-color: var(--success-color);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
      /* Green glow effect */
    }

    /* Make price text green when agent mode is active */
    html.dark .material-card:has(.agent-toggle.agent-active) .material-info span {
      color: var(--success-color);
    }

    /* Make price text green in LIGHT MODE when agent mode is active */
    .material-card:has(.agent-toggle.agent-active) .material-info span {
      color: #28a745;
      /* The success color from the light theme */
    }

    .material-card:has(.agent-toggle.agent-active) {
      border-color: #28a745;
      box-shadow: 0 0 12px rgba(40, 167, 69, 0.5);
    }

    /* --- Dark Mode Calculator Panel Styles --- */
    html.dark .calculator-panel {
      background-color: var(--content-bg);
      border-color: var(--border-color);
    }

    /* Style for Text, Inputs, and Dropdowns */
    html.dark .calculator-panel label,
    html.dark .calculator-panel .checkbox-group label {
      color: var(--text-secondary);
    }

    html.dark .calculator-panel input[type="number"],
    html.dark .calculator-panel select,
    html.dark .calculator-panel .invoice-copy-area textarea {
      background-color: #374151;
      /* Tailwind gray-700 */
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    html.dark .calculator-panel input[type="number"]:focus,
    html.dark .calculator-panel select:focus,
    html.dark .calculator-panel .invoice-copy-area textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    /* Style for Buttons */
    html.dark .calculator-panel .size-btn {
      background-color: #374151;
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    html.dark .calculator-panel .size-btn:hover {
      background-color: #4b5563;
      /* Lighter gray */
    }

    html.dark .calculator-panel .size-btn.active {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: #ffffff;
    }

    html.dark .calculator-panel .btn-secondary {
      background-color: #374151;
      color: var(--text-primary);
    }

    /* Style for Checkbox */
    html.dark .calculator-panel .checkbox-group label::before {
      background-color: #374151;
      border-color: var(--border-color);
    }

    html.dark .calculator-panel input[type="checkbox"]:checked+label::before {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    /* Style for Result Area */
    html.dark .calculator-panel .result {
      background-color: var(--light-bg);
      /* Use the darkest theme color */
      color: var(--text-secondary);
    }

    html.dark .calculator-panel .result strong {
      color: var(--primary-color);
      font-size: 22px;
    }

    /* Style for Government Checkbox */
    html.dark .calculator-panel .modern-checkbox-grid .checkbox-group {
      background-color: #374151;
      /* Match the input field background */
      border-color: var(--border-color);
    }

    html.dark .calculator-panel .modern-checkbox-grid input[type="checkbox"] {
      accent-color: var(--primary-color);
      /* Sets the color of the checkmark */
    }

    /* Make price text green when agent mode is active */
    html.dark .material-card.active {
      background-image:
        /* Top Layer: A smaller, brighter, more electric blue hotspot */
        radial-gradient(ellipse at top right, rgba(129, 140, 248, 0.5) 100%, transparent 100%),
        /* Bottom Layer: A larger, deep indigo ambient glow */
        radial-gradient(ellipse at top right, rgba(79, 70, 229, 0.4) 100%, transparent 80%);
    }

    .material-card.active {
      border: 2px solid var(--primary-color);
      box-shadow: 0 0 12px rgba(0, 123, 255, 0.3);
    }

    html.dark .material-card.active {
      background-image: radial-gradient(ellipse at top right, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
    }

    .material-info {
      padding: 12px 16px;
      flex-grow: 1;
    }

    .material-info strong {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .material-info span {
      display: block;
      font-size: 15px;
      color: var(--primary-color);
      margin-top: 4px;
      font-weight: 600;
    }

    .agent-toggle {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-top: 1px solid var(--border-color);
      cursor: pointer;
      color: var(--text-secondary);
      background: #f8f9fa;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .agent-toggle:hover {
      background: #e9ecef;
    }

    .agent-toggle.agent-active {
      background: var(--success-color);
      color: white;
    }

    .agent-toggle.agent-active:hover {
      background: #218838;
    }

    .calculator-panel {
      margin-top: 24px;
      background: var(--content-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      max-width: 800px;
    }

    .settings-panel {
      margin-top: 24px;
      background: var(--content-bg);
      padding: 24px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      max-width: 1100px;
    }

    label {
      font-weight: 600;
      margin: 8px 0 4px 0;
      /* Reduced top and bottom margins */
      display: block;
      color: var(--text-primary);
      font-size: 14px;
    }

    input[type="number"],
    input[type="text"],
    select,
    textarea {
      display: block;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 4x;
      font-size: 16px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-bottom: 0;
    }

    .checkbox-group label {
      margin: 0;
      font-weight: 500;
    }

    .btn {
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 14px;
    }

    .btn-primary {
      width: 100%;
      background: var(--primary-color);
      color: #fff;
      margin-top: 24px;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: #fff;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-danger {
      background: var(--danger-color);
      color: #fff;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-link {
      background: var(--accent-color);
      color: white;
      text-decoration: none;
      text-align: center;
      display: block;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      padding: 12px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    .btn-link:hover {
      background: #138496;
    }

    .result {
      margin-top: 16px;
      padding: 15px;
      background: var(--light-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      font-size: 16px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .result strong {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    canvas {
      margin-top: 16px;
      border: 1px solid var(--border-color);
      max-width: 100%;
      background: #fff;
      border-radius: var(--border-radius);
    }

    .invoice-copy-area {
      margin-top: 24px;
    }

    .invoice-copy-area textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      font-family: 'Menlo', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      background-color: #e9ecef;
      color: #495057;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      resize: vertical;
    }

    .invoice-copy-area button {
      width: auto;
      padding: 10px 20px;
      margin-top: 8px;
      float: right;
    }

    .calculator-container {
      background: var(--content-bg);
      border-radius: var(--border-radius);
      padding: 32px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
      max-width: 800px;
      width: 100%;
      margin: auto;
    }

    .calculator-container h2 {
      margin-top: 0;
      color: var(--text-primary);
      text-align: center;
      font-size: 24px;
      margin-bottom: 24px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .option-box {
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 16px;
    }

    .option-box label {
      margin-top: 0;
      margin-bottom: 12px;
    }

    .invoice {
      margin-top: 32px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .invoice-body {
      padding: 24px;
    }

    .invoice-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 16px;
    }

    .invoice-row:last-child {
      border-bottom: none;
    }

    .invoice-label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .invoice-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .invoice-nett {
      background: var(--primary-color);
      color: #fff;
      padding: 16px 24px;
      text-align: right;
      font-size: 20px;
      font-weight: 700;
    }

    .size-btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .size-btn {
      padding: 10px 16px;
      background: var(--content-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all .2s ease;
      flex-grow: 1;
      text-align: center;
    }

    .size-btn:hover {
      background: var(--light-bg);
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .size-btn.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: #fff;
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
      transform: translateY(-2px);
    }

    .modern-checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .modern-checkbox-grid .checkbox-group {
      margin: 0;
      background-color: #fff;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      transition: all .2s ease-in-out;
    }

    .modern-checkbox-grid .checkbox-group:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .modern-checkbox-grid input[type="checkbox"] {
      opacity: 0;
      position: absolute;
      width: 0;
      height: 0;
    }

    .modern-checkbox-grid label {
      position: relative;
      padding-left: 32px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      height: 100%;
    }

    .modern-checkbox-grid label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      background: #fff;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .modern-checkbox-grid label::after {
      content: '✔';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%) scale(0);
      font-size: 14px;
      font-weight: bold;
      color: white;
      transition: all 0.2s ease;
    }

    .modern-checkbox-grid input[type="checkbox"]:checked+label::before {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .modern-checkbox-grid input[type="checkbox"]:checked+label::after {
      transform: translateY(-50%) scale(1);
    }

    .settings-table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0;
      font-size: 14px;
    }

    .settings-table th,
    .settings-table td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
      vertical-align: middle;
    }

    .settings-table th {
      background: var(--light-bg);
      font-weight: 600;
      text-align: center;
    }

    .settings-table tr:nth-child(even) {
      background: var(--light-bg);
    }

    .settings-table .action-buttons {
      display: flex;
      gap: 8px;
    }

    .settings-table input[type="number"] {
      padding: 8px;
      font-size: 14px;
      max-width: 80px;
      text-align: center;
    }

    .settings-table .header-2line {
      line-height: 1.2;
    }

    /*
    ========================================
    Sticker Layout Editor Specific Styles
    ========================================
    */
    .sticker-editor-wrapper {
      font-family: 'Poppins', sans-serif;
      padding: 25px;
      background: var(--light-bg);
      /* Now uses the theme's background color */
      color: #333;
      line-height: 1.6;
      width: 100%;
      box-sizing: border-box;
    }

    .sticker-editor-wrapper h2 {
      text-align: center;
      color: #0056b3;
      margin-bottom: 30px;
      font-size: 2.3em;
      font-weight: 700;
    }

    .sticker-editor-wrapper .container {
      max-width: 880px;
      margin: 0 auto;
      background: #ffffff;
      padding: 35px 45px;
      border-radius: 15px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    }

    .sticker-editor-wrapper label {
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
      color: #475569;
    }

    .sticker-editor-wrapper input[type="number"],
    .sticker-editor-wrapper select {
      font-family: 'Poppins', sans-serif;
      padding: 14px 18px;
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 1.08em;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .sticker-editor-wrapper input[type="number"]:focus,
    .sticker-editor-wrapper select:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 0.35rem rgba(0, 123, 255, 0.18);
    }

    .sticker-editor-wrapper .row {
      display: flex;
      gap: 30px;
      margin-bottom: 25px;
      align-items: flex-end;
    }

    .sticker-editor-wrapper .row>div {
      flex: 1;
    }

    .sticker-editor-wrapper .result {
      padding: 30px;
      background: #eaf4ff;
      border: 1px solid #a3c9f0;
      border-radius: 12px;
      margin-top: 40px;
      font-size: 1.2em;
      color: #004085;
      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    .sticker-editor-wrapper .result strong {
      color: #0056b3;
      font-weight: 700;
    }

    .sticker-editor-wrapper canvas {
      display: block;
      border: 1px solid #e2e8f0;
      margin-top: 10px;
      background: #fdfdfd;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      max-width: 100%;
      height: auto;
    }

    .sticker-editor-wrapper .info-text {
      font-size: 0.98em;
      color: #71717a;
      display: block;
      font-style: italic;
    }

    .sticker-editor-wrapper .general-info-text {
      margin-top: -18px;
      margin-bottom: 30px;
    }

    .sticker-editor-wrapper .spacing-input-group {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .sticker-editor-wrapper .spacing-input-group input,
    .sticker-editor-wrapper .spacing-input-group select {
      margin-bottom: 0;
    }

    .sticker-editor-wrapper .spacing-input-group input {
      flex-grow: 1;
    }

    .sticker-editor-wrapper .spacing-unit-select {
      width: auto;
      flex-shrink: 0;
    }

    .sticker-editor-wrapper .artwork-control-grid {
      display: flex;
      gap: 30px;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .sticker-editor-wrapper .artwork-presets-column {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sticker-editor-wrapper .artwork-upload-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      min-width: 0;
      flex-shrink: 1;
    }

    .sticker-editor-wrapper .artwork-upload-column label {
      margin-bottom: 0;
    }

    .sticker-editor-wrapper .preset-buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sticker-editor-wrapper .preset-button {
      flex: 1 1 calc(20% - 8px);
      max-width: calc(20% - 8px);
      box-sizing: border-box;
      padding: 11px 18px;
      background-color: #eef2f6;
      border: 1px solid #d4dbe4;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.98em;
      font-weight: 600;
      color: #1e3a8a;
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
    }

    .sticker-editor-wrapper .preset-button:hover {
      background-color: #dbe4ee;
      border-color: #a7b7c2;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      color: #0056b3;
    }

    .sticker-editor-wrapper .preset-button:active,
    .sticker-editor-wrapper .preset-button.active {
      background-color: #007bff;
      color: #ffffff;
      border-color: #007bff;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.25);
    }

    .sticker-editor-wrapper .row+.info-text {
      margin-top: -18px;
      margin-bottom: 30px;
    }

    .sticker-editor-wrapper .file-upload-group {
      margin-bottom: 0;
    }

    .sticker-editor-wrapper .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 0;
    }

    .sticker-editor-wrapper .custom-file-upload-button {
      display: inline-block;
      padding: 7px 18px;
      background-color: #007bff;
      color: #ffffff;
      border: 1px solid #007bff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.98em;
      font-weight: 600;
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      flex-shrink: 0;
    }

    .sticker-editor-wrapper .custom-file-upload-button:hover {
      background-color: #0056b3;
      border-color: #004085;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.25);
    }

    .sticker-editor-wrapper .file-name-display {
      font-size: 0.98em;
      color: #475569;
      flex-grow: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      min-width: 0;
      flex-basis: 0;
    }

    .sticker-editor-wrapper .clear-image-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 0;
      margin-bottom: 0;
    }

    .sticker-editor-wrapper .clear-image-controls .btn-control {
      padding: 11px 18px;
      font-size: 0.98em;
      width: auto;
      background-color: #eef2f6;
      border: 1px solid #d4dbe4;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 200;
      color: #1e3a8a;
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      flex-shrink: 0;
    }

    .sticker-editor-wrapper .clear-image-controls .info-text {
      font-size: 0.85em;
      margin-top: 0;
      margin-bottom: 0;
      flex-grow: 1;
    }

    .sticker-editor-wrapper .invoice-copy-area {
      margin-top: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .sticker-editor-wrapper .invoice-copy-area label {
      font-size: 1.1em;
      font-weight: 700;
      color: #343a40;
      margin-bottom: 15px;
      align-self: flex-start;
    }

    .sticker-editor-wrapper #invoiceText {
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      color: #495057;
      white-space: pre-wrap;
      word-wrap: break-word;
      resize: vertical;
      width: 100%;
      height: 180px;
      padding: 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      box-sizing: border-box;
      background-color: #ffffff;
      line-height: 1.5;
      transition: border-color 0.2s ease-in-out;
      margin-bottom: 15px;
    }

    .sticker-editor-wrapper #invoiceText:focus {
      border-color: #007bff;
      outline: none;
    }

    .sticker-editor-wrapper .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .sticker-editor-wrapper .btn-secondary {
      background-color: #6c757d;
      color: #ffffff;
    }

    .sticker-editor-wrapper .btn-secondary:hover {
      background-color: #5a6268;
      transform: translateY(-1px);
    }

    .sticker-editor-wrapper .btn-control {
      padding: 11px 18px;
      font-size: 0.9em;
      width: auto;
      background-color: #eef2f6;
      border: 1px solid #d4dbe4;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      color: #1e3a8a;
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
    }

    .sticker-editor-wrapper .btn-control:hover {
      background-color: #dbe4ee;
      border-color: #a7b7c2;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      color: #0056b3;
    }

    .sticker-editor-wrapper .btn.active-control {
      background-color: #007bff !important;
      color: #ffffff !important;
      border-color: #007bff !important;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.25) !important;
    }

    .sticker-editor-wrapper .canvas-summary-text {
      font-family: 'Poppins', sans-serif;
      font-size: 1.1em;
      font-weight: 600;
      color: #343a40;
      text-align: center;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    .sticker-editor-wrapper .input-with-stepper {
      display: flex;
      align-items: center;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
    }

    .sticker-editor-wrapper .stepper-button {
      background-color: #f8f9fa;
      border: none;
      padding: 14px 10px;
      cursor: pointer;
      font-size: 1em;
      color: #475569;
      transition: background-color 0.2s ease, color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sticker-editor-wrapper .stepper-button:hover {
      background-color: #e2e8f0;
      color: #0056b3;
    }

    .sticker-editor-wrapper .stepper-button:first-child {
      border-right: 1px solid #cbd5e1;
    }

    .sticker-editor-wrapper .stepper-button:last-child {
      border-left: 1px solid #cbd5e1;
    }

    .sticker-editor-wrapper .artwork-unit-controls {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .sticker-editor-wrapper .artwork-unit-controls select {
      flex-grow: 1;
    }

    .sticker-editor-wrapper .artwork-unit-controls button {
      padding-left: 12px;
      padding-right: 12px;
      font-size: 1.2em;
    }

    /* This style is for the currently active page link in the navigation drawer */
    #drawer-navigation a.sidebar-active {
      background-color: #3b82f6;
      /* Tailwind's blue-500 */
      color: white;
    }

    /* Ensure the icon inside the active link is also white */
    #drawer-navigation a.sidebar-active i,
    #drawer-navigation a.sidebar-active svg {
      color: white;
    }

    /* --- Dark Mode Fix for Flowbite Drawer/Sidebar --- */
    html.dark #drawer-navigation {
      background-color: #1f2937;
      /* This is Tailwind's gray-800 */
    }

    /* --- FIX for Sidebar Backdrop Opacity --- */
    /* Sets the backdrop for light mode */
    div[data-drawer-backdrop] {
      background-color: rgba(55, 65, 81, 0.5);
      /* A dark gray at 50% opacity */
    }

    /* Sets a stronger backdrop for dark mode */
    html.dark div[data-drawer-backdrop] {
      background-color: rgba(17, 24, 39, 0.8);
      /* A near-black at 80% opacity */
    }
  </style>
</head>

<body>

  <!-- Drawer init and show button -->
  <div class="p-4 flex gap-2">
    <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" type="button" data-drawer-target="drawer-navigation" data-drawer-show="drawer-navigation" aria-controls="drawer-navigation" data-drawer-backdrop="true">
      <i class="fas fa-bars mr-2"></i> Show Navigation
    </button>
    <button class="text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-500 dark:hover:bg-gray-600 focus:outline-none dark:focus:ring-gray-800" type="button" onclick="loadPage('home')">
      <i class="fas fa-home mr-2"></i> Home
    </button>
    <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
      <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
      </svg>
      <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100 2H2a1 1 0 100-2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
      </svg>
    </button>
  </div>

  <!-- Drawer component -->
  <div id="drawer-navigation" class="fixed top-0 left-0 z-40 w-64 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-white dark:bg-gray-800" tabindex="-1" aria-labelledby="drawer-navigation-label">
    <h5 id="drawer-navigation-label" class="text-base font-semibold text-gray-500 uppercase dark:text-gray-400">Menu</h5>
    <button type="button" data-drawer-hide="drawer-navigation" aria-controls="drawer-navigation" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 absolute top-2.5 end-2.5 inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
      <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
      <span class="sr-only">Close menu</span>
    </button>
    <div class="py-4 overflow-y-auto">
      <ul class="space-y-2 font-medium">
        <li>
          <a href="#" onclick="loadPage('home');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-home w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Home</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('largeFormat');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-expand-arrows-alt w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Large Format</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('signboard');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-sign w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Signboard</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('stand');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M13.09 3.294c1.924.95 3.422 1.69 5.472.692a1 1 0 0 1 1.438.9v9.54a1 1 0 0 1-.562.9c-2.981 1.45-5.382.24-7.25-.701a38.739 38.739 0 0 0-.622-.31c-1.033-.497-1.887-.812-2.756-.77-.76.036-1.672.357-2.81 1.396V21a1 1 0 1 1-2 0V4.971a1 1 0 0 1 .297-.71c1.522-1.506 2.967-2.185 4.417-2.255 1.407-.068 2.653.453 3.72.967.225.108.443.216.655.32Z" />
            </svg>
            <span class="ms-3">Stand</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('businessCard');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-address-card w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Business Card</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('invitationCard');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-envelope-open-text w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Invitation Card</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('sublimation');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-tshirt w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Sublimation</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('idCard');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-id-card w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">ID Card</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('stickerLayout');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-sticky-note w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Sticker Layout</span>
          </a>
        </li>
        <li>
          <a href="#" onclick="loadPage('settings');" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
            <i class="fas fa-cog w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
            <span class="ms-3">Settings</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <div class="content" id="contentArea">
    <!-- Content will be loaded here by JavaScript -->
  </div>

  <div id="currencyModal" class="fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl m-4 flex flex-col">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-xl font-semibold text-gray-900">Select a currency</h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" onclick="closeCurrencyModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <div class="p-4 border-b">
        <input type="text" id="currencySearch" onkeyup="openCurrencyModal()" placeholder="Search currency (e.g., USD, Dollar)" class="w-full p-2 border border-gray-300 rounded-md">
      </div>
      <div id="currencyList" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-1 max-h-[60vh] overflow-y-auto">
      </div>
      <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-lg">
        <button id="saveCurrencyBtn" onclick="selectCurrency()" class="text-white bg-blue-700 hover:bg-blue-800 disabled:bg-gray-400 disabled:cursor-not-allowed font-medium rounded-lg text-sm px-5 py-2.5" style="width: auto; margin-top:0;" disabled>Save Changes</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <script>
    // =================================================================================
    // SCRIPT FOR STICKER LAYOUT EDITOR
    // =================================================================================
    // Global variables for the sticker editor, encapsulated to avoid conflicts
    const stickerEditorState = {
      currentArtworkUnit: "cm",
      currentPaperUnit: "in",
      currentSpacingUnit: "cm",
      uploadedImage: null,
      artworkOrientation: 'normal',
      isRatioLocked: false,
      lockedAspectRatio: 1,
      originalArtworkDimensions: {
        width: null,
        height: null
      },
      originalUploadedImageRatio: 1,
      unitToInch: {
        "in": 1,
        "cm": 0.393701,
        "mm": 0.0393701,
        "ft": 12
      },
      artworkPresets: {
        "1": {
          horizontal: 0.1,
          vertical: 0.2,
          unit: "cm",
          layoutMode: "optimized"
        },
        "2": {
          horizontal: 0.1,
          vertical: 0.08,
          unit: "cm",
          layoutMode: "optimized"
        },
        "3": {
          horizontal: 0.1,
          vertical: 0.1,
          unit: "cm",
          layoutMode: "optimized"
        },
        "4": {
          horizontal: 0.05,
          vertical: 0.3,
          unit: "cm",
          layoutMode: "optimized"
        },
        "5": {
          horizontal: 0.2,
          vertical: 0.2,
          unit: "cm",
          layoutMode: "optimized"
        },
        "6": {
          horizontal: 0.4,
          vertical: -0.12,
          unit: "cm",
          layoutMode: "optimized"
        },
        "7": {
          horizontal: 0.1,
          vertical: 1,
          unit: "cm",
          layoutMode: "optimized"
        },
        "8": {
          horizontal: 2,
          vertical: -0.3,
          unit: "cm",
          layoutMode: "optimized"
        },
        "9": {
          horizontal: 0.4,
          vertical: 0.4,
          unit: "cm",
          layoutMode: "optimized"
        },
        "10": {
          horizontal: -0.8,
          vertical: 0.5,
          unit: "cm",
          layoutMode: "brickByColumn"
        },
      }
    };

    function convertToInches(val, unit) {
      if (isNaN(val)) return 0;
      return val * stickerEditorState.unitToInch[unit];
    }

    function convertFromInches(val, targetUnit) {
      if (isNaN(val)) return 0;
      return val / stickerEditorState.unitToInch[targetUnit];
    }

    function updateArtworkDimensions(changedField) {
      const artworkWidthInput = document.getElementById("artworkWidth");
      const artworkHeightInput = document.getElementById("artworkHeight");
      let currentWidth = parseFloat(artworkWidthInput.value);
      let currentHeight = parseFloat(artworkHeightInput.value);
      if (stickerEditorState.originalArtworkDimensions.width === null || stickerEditorState.originalArtworkDimensions.height === null) {
        stickerEditorState.originalArtworkDimensions.width = currentWidth;
        stickerEditorState.originalArtworkDimensions.height = currentHeight;
        stickerEditorState.lockedAspectRatio = currentHeight > 0 ? currentWidth / currentHeight : 1;
      } else if (!stickerEditorState.isRatioLocked) {
        if (currentWidth > 0 && currentHeight > 0) {
          stickerEditorState.lockedAspectRatio = currentWidth / currentHeight;
        }
      }
      if (stickerEditorState.isRatioLocked && !isNaN(currentWidth) && !isNaN(currentHeight)) {
        if (changedField === 'width' && currentWidth > 0) {
          artworkHeightInput.value = (currentWidth / stickerEditorState.lockedAspectRatio).toFixed(1);
        } else if (changedField === 'height' && currentHeight > 0) {
          artworkWidthInput.value = (currentHeight * stickerEditorState.lockedAspectRatio).toFixed(1);
        }
      }
      calculateLayout();
    }

    function toggleArtworkUnit() {
      const newUnit = document.getElementById("unitSelect").value;
      if (newUnit === stickerEditorState.currentArtworkUnit) return;
      const fields = ["artworkWidth", "artworkHeight"];
      fields.forEach(id => {
        let input = document.getElementById(id);
        let valInInches = convertToInches(parseFloat(input.value), stickerEditorState.currentArtworkUnit);
        if (!isNaN(valInInches) && input.value !== "") {
          input.value = convertFromInches(valInInches, newUnit).toFixed(1);
        }
      });
      if (stickerEditorState.originalArtworkDimensions.width !== null && stickerEditorState.originalArtworkDimensions.height !== null) {
        const originalWidthInInches = convertToInches(stickerEditorState.originalArtworkDimensions.width, stickerEditorState.currentArtworkUnit);
        const originalHeightInInches = convertToInches(stickerEditorState.originalArtworkDimensions.height, stickerEditorState.currentArtworkUnit);
        stickerEditorState.originalArtworkDimensions.width = convertFromInches(originalWidthInInches, newUnit);
        stickerEditorState.originalArtworkDimensions.height = convertFromInches(originalHeightInInches, newUnit);
      }
      stickerEditorState.currentArtworkUnit = newUnit;
      calculateLayout();
    }

    function toggleCustomPaperUnit() {
      const newUnit = document.getElementById("customUnitSelect").value;
      if (newUnit === stickerEditorState.currentPaperUnit) return;
      const fields = ["paperWidth", "paperHeight"];
      fields.forEach(id => {
        let input = document.getElementById(id);
        let valInInches = convertToInches(parseFloat(input.value), stickerEditorState.currentPaperUnit);
        if (!isNaN(valInInches) && input.value !== "") {
          input.value = convertFromInches(valInInches, newUnit).toFixed(2);
        }
      });
      stickerEditorState.currentPaperUnit = newUnit;
      updatePaperSizeOptions(newUnit);
      calculateLayout();
    }

    function toggleSpacingUnit() {
      const newUnit = document.getElementById("spacingUnitSelect").value;
      if (newUnit === stickerEditorState.currentSpacingUnit) return;
      const fields = ["artworkHorizontalSpacing", "artworkVerticalSpacing"];
      fields.forEach(id => {
        let input = document.getElementById(id);
        let valInInches = convertToInches(parseFloat(input.value), stickerEditorState.currentSpacingUnit);
        if (!isNaN(valInInches) && input.value !== "") {
          input.value = convertFromInches(valInInches, newUnit).toFixed(2);
        }
      });
      document.getElementById("spacingInfoUnit").textContent = newUnit;
      stickerEditorState.currentSpacingUnit = newUnit;
      calculateLayout();
    }

    function updatePaperSizeOptions(unit) {
      const options = [{
        el: document.querySelector('#paperSize option[value="11.7,16.5"]'),
        w: 11.7,
        h: 16.5,
        text: "A3"
      }, {
        el: document.querySelector('#paperSize option[value="12,18"]'),
        w: 12,
        h: 18,
        text: "12x18"
      }, {
        el: document.querySelector('#paperSize option[value="12,18.5"]'),
        w: 12,
        h: 18.5,
        text: "12x18.5"
      }, {
        el: document.querySelector('#paperSize option[value="12,19"]'),
        w: 12,
        h: 19,
        text: "12x19"
      }, {
        el: document.querySelector('#paperSize option[value="13,19"]'),
        w: 13,
        h: 19,
        text: "13x19"
      }];
      options.forEach(opt => {
        if (opt.el) {
          let wConv = convertFromInches(opt.w, unit).toFixed(2);
          let hConv = convertFromInches(opt.h, unit).toFixed(2);
          opt.el.textContent = `${opt.text} (${wConv}${unit} x ${hConv}${unit})`;
        }
      });
    }

    function activatePresetButton(size) {
      document.querySelectorAll('.sticker-editor-wrapper .preset-button').forEach(button => {
        button.classList.remove('active');
        if (button.textContent === size + 'cm') {
          button.classList.add('active');
        }
      });
    }

    function applyPresetArtworkSize(sizeCm) {
      const convertedSize = convertFromInches(convertToInches(sizeCm, "cm"), stickerEditorState.currentArtworkUnit);
      document.getElementById("artworkWidth").value = convertedSize.toFixed(1);
      document.getElementById("artworkHeight").value = convertedSize.toFixed(1);
      stickerEditorState.originalArtworkDimensions.width = parseFloat(document.getElementById("artworkWidth").value);
      stickerEditorState.originalArtworkDimensions.height = parseFloat(document.getElementById("artworkHeight").value);
      stickerEditorState.lockedAspectRatio = stickerEditorState.originalArtworkDimensions.height > 0 ? stickerEditorState.originalArtworkDimensions.width / stickerEditorState.originalArtworkDimensions.height : 1;
      toggleLockRatio(true);
      stickerEditorState.currentPaperUnit = "in";
      document.getElementById("customUnitSelect").value = "in";
      const preset = stickerEditorState.artworkPresets[sizeCm.toString()];
      if (preset) {
        document.getElementById("spacingUnitSelect").value = preset.unit;
        stickerEditorState.currentSpacingUnit = preset.unit;
        document.getElementById("artworkHorizontalSpacing").value = convertFromInches(convertToInches(preset.horizontal, preset.unit), stickerEditorState.currentSpacingUnit).toFixed(2);
        document.getElementById("artworkVerticalSpacing").value = convertFromInches(convertToInches(preset.vertical, preset.unit), stickerEditorState.currentSpacingUnit).toFixed(2);
        document.getElementById("layoutMode").value = preset.layoutMode;
        toggleSpacingUnit();
      }
      activatePresetButton(sizeCm);
      stickerEditorState.artworkOrientation = 'normal';
      calculateLayout();
    }

    function handleImageUpload() {
      const fileInput = document.getElementById('artworkImage');
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      const file = fileInput.files[0];
      if (file) {
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file (e.g., JPG, PNG, GIF).');
          clearUploadedImage();
          return;
        }
        fileNameDisplay.textContent = file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
          stickerEditorState.uploadedImage = new Image();
          stickerEditorState.uploadedImage.onload = function() {
            stickerEditorState.originalUploadedImageRatio = stickerEditorState.uploadedImage.width / stickerEditorState.uploadedImage.height;
            const artworkWidthInput = document.getElementById("artworkWidth");
            const artworkHeightInput = document.getElementById("artworkHeight");
            let currentArtW = parseFloat(artworkWidthInput.value) || 5.0;
            let currentArtH = parseFloat(artworkHeightInput.value) || 5.0;
            const maxDim = Math.max(currentArtW, currentArtH);
            let newWidth, newHeight;
            if (stickerEditorState.originalUploadedImageRatio > 1) {
              newWidth = maxDim;
              newHeight = maxDim / stickerEditorState.originalUploadedImageRatio;
            } else {
              newHeight = maxDim;
              newWidth = maxDim * stickerEditorState.originalUploadedImageRatio;
            }
            artworkWidthInput.value = newWidth.toFixed(1);
            artworkHeightInput.value = newHeight.toFixed(1);
            stickerEditorState.originalArtworkDimensions.width = newWidth;
            stickerEditorState.originalArtworkDimensions.height = newHeight;
            toggleLockRatio(true);
            stickerEditorState.artworkOrientation = 'normal';
            calculateLayout();
          };
          stickerEditorState.uploadedImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        clearUploadedImage();
      }
    }

    function clearUploadedImage() {
      stickerEditorState.uploadedImage = null;
      stickerEditorState.originalUploadedImageRatio = 1;
      document.getElementById('artworkImage').value = '';
      document.getElementById('fileNameDisplay').textContent = 'No file chosen';
      document.getElementById("artworkWidth").value = (5.0).toFixed(1);
      document.getElementById("artworkHeight").value = (5.0).toFixed(1);
      stickerEditorState.originalArtworkDimensions.width = 5.0;
      stickerEditorState.originalArtworkDimensions.height = 5.0;
      stickerEditorState.lockedAspectRatio = 1;
      setFreeSize();
      stickerEditorState.artworkOrientation = 'normal';
      calculateLayout();
    }

    function copyStickerInvoiceText() {
      const invoiceText = document.getElementById("invoiceText");
      invoiceText.select();
      navigator.clipboard.writeText(invoiceText.value).then(() => {
        const copyBtn = document.getElementById("copyBtn");
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }

    function setActiveControlButton(activeButton, allButtons) {
      allButtons.forEach(button => {
        button.classList.remove("active-control");
        button.classList.add("btn-control");
      });
      activeButton.classList.add("active-control");
      activeButton.classList.remove("btn-control");
    }

    function toggleLockRatio(forceLock = false) {
      const artworkWidthInput = document.getElementById("artworkWidth");
      const artworkHeightInput = document.getElementById("artworkHeight");
      const lockRatioBtn = document.getElementById("lockRatioBtn");
      const freeSizeBtn = document.getElementById("freeSizeBtn");
      const revertBtn = document.getElementById("revertBtn");
      const resizeToFitBtn = document.getElementById("resizeToFitBtn");
      const controlButtons = [lockRatioBtn, freeSizeBtn, revertBtn, resizeToFitBtn];
      if (forceLock || !stickerEditorState.isRatioLocked) {
        stickerEditorState.isRatioLocked = true;
        setActiveControlButton(lockRatioBtn, controlButtons);
        const currentWidth = parseFloat(artworkWidthInput.value);
        const currentHeight = parseFloat(artworkHeightInput.value);
        stickerEditorState.lockedAspectRatio = currentHeight > 0 ? currentWidth / currentHeight : 1;
        artworkHeightInput.disabled = true;
        artworkWidthInput.disabled = false;
        updateArtworkDimensions('width');
      } else {
        setFreeSize();
      }
    }

    function setFreeSize() {
      stickerEditorState.isRatioLocked = false;
      const lockRatioBtn = document.getElementById("lockRatioBtn");
      const freeSizeBtn = document.getElementById("freeSizeBtn");
      const revertBtn = document.getElementById("revertBtn");
      const resizeToFitBtn = document.getElementById("resizeToFitBtn");
      const controlButtons = [lockRatioBtn, freeSizeBtn, revertBtn, resizeToFitBtn];
      setActiveControlButton(freeSizeBtn, controlButtons);
      document.getElementById("artworkWidth").disabled = false;
      document.getElementById("artworkHeight").disabled = false;
      calculateLayout();
    }

    function revertToOriginalSize() {
      if (stickerEditorState.originalArtworkDimensions.width !== null && stickerEditorState.originalArtworkDimensions.height !== null) {
        document.getElementById("artworkWidth").value = stickerEditorState.originalArtworkDimensions.width.toFixed(1);
        document.getElementById("artworkHeight").value = stickerEditorState.originalArtworkDimensions.height.toFixed(1);
        stickerEditorState.lockedAspectRatio = stickerEditorState.uploadedImage ? stickerEditorState.originalUploadedImageRatio : (stickerEditorState.originalArtworkDimensions.width / stickerEditorState.originalArtworkDimensions.height);
        toggleLockRatio(true);
        stickerEditorState.artworkOrientation = 'normal';
        calculateLayout();
      }
    }

    function resizeArtworkToFitPaper() {
      let paperWidth, paperHeight;
      const selectedSize = document.getElementById("paperSize").value;
      if (selectedSize === "custom") {
        paperWidth = getInputInInches("paperWidth", 'paper');
        paperHeight = getInputInInches("paperHeight", 'paper');
      } else {
        const [w, h] = selectedSize.split(',').map(Number);
        paperWidth = w;
        paperHeight = h;
      }
      const marginLeft = 0.3937,
        marginRight = 0.3937,
        marginTop = 0.3937,
        marginBottom = 1.1811;
      const usableWidth = paperWidth - marginLeft - marginRight;
      const usableHeight = paperHeight - marginTop - marginBottom;
      const currentArtW_in = getInputInInches("artworkWidth", 'artwork');
      const currentArtH_in = getInputInInches("artworkHeight", 'artwork');
      if (currentArtW_in <= 0 || currentArtH_in <= 0) return;
      const currentArtworkAspectRatio = stickerEditorState.uploadedImage ? stickerEditorState.originalUploadedImageRatio : (currentArtW_in / currentArtH_in);
      let newArtW_in = usableWidth;
      let newArtH_in = usableWidth / currentArtworkAspectRatio;
      if (newArtH_in > usableHeight) {
        newArtH_in = usableHeight;
        newArtW_in = usableHeight * currentArtworkAspectRatio;
      }
      document.getElementById("artworkWidth").value = convertFromInches(newArtW_in, stickerEditorState.currentArtworkUnit).toFixed(1);
      document.getElementById("artworkHeight").value = convertFromInches(newArtH_in, stickerEditorState.currentArtworkUnit).toFixed(1);
      toggleLockRatio(true);
      stickerEditorState.artworkOrientation = 'normal';
      calculateLayout();
    }

    function rotateArtwork() {
      const artworkWidthInput = document.getElementById("artworkWidth");
      const artworkHeightInput = document.getElementById("artworkHeight");
      let currentWidth = parseFloat(artworkWidthInput.value);
      let currentHeight = parseFloat(artworkHeightInput.value);
      if (isNaN(currentWidth) || isNaN(currentHeight)) return;
      artworkWidthInput.value = currentHeight.toFixed(1);
      artworkHeightInput.value = currentWidth.toFixed(1);
      stickerEditorState.artworkOrientation = (stickerEditorState.artworkOrientation === 'normal') ? 'rotated' : 'normal';
      if (stickerEditorState.isRatioLocked) {
        stickerEditorState.lockedAspectRatio = currentWidth > 0 ? currentHeight / currentWidth : 1;
      }
      calculateLayout();
    }

    function calculateLayout() {
      let paperW, paperH;
      const paperSizeSelect = document.getElementById("paperSize");
      if (!paperSizeSelect) return;
      const selectedSize = paperSizeSelect.value;
      if (selectedSize === "custom") {
        paperW = getInputInInches("paperWidth", 'paper');
        paperH = getInputInInches("paperHeight", 'paper');
      } else {
        const [w, h] = selectedSize.split(',').map(Number);
        paperW = w;
        paperH = h;
      }
      const artW = getInputInInches("artworkWidth", 'artwork');
      const artH = getInputInInches("artworkHeight", 'artwork');
      const horizSpacing = getInputInInches("artworkHorizontalSpacing", 'spacing');
      const vertSpacing = getInputInInches("artworkVerticalSpacing", 'spacing');
      const stickerShape = document.getElementById("stickerShape").value;
      const layoutMode = document.getElementById("layoutMode").value;
      const marginLeft = 0.3937,
        marginRight = 0.3937,
        marginTop = 0.3937,
        marginBottom = 1.1811;
      const usableWidth = paperW - marginLeft - marginRight;
      const usableHeight = paperH - marginTop - marginBottom;
      let actualStickerShape = stickerShape;
      if (stickerShape === "round") {
        actualStickerShape = Math.abs(artW - artH) < 0.001 ? "round" : "oval";
      } else {
        actualStickerShape = Math.abs(artW - artH) < 0.001 ? "square" : "rectangle";
      }
      const actualFitResult = drawCanvas(paperW, paperH, artW, artH, horizSpacing, vertSpacing, marginLeft, marginTop, marginRight, marginBottom, actualStickerShape, layoutMode, usableWidth, usableHeight);
      const artworkDisplayWidth = convertFromInches(artW, stickerEditorState.currentArtworkUnit).toFixed(1);
      const artworkDisplayHeight = convertFromInches(artH, stickerEditorState.currentArtworkUnit).toFixed(1);
      const displayPaperWidth = convertFromInches(paperW, stickerEditorState.currentPaperUnit).toFixed(2);
      const displayPaperHeight = convertFromInches(paperH, stickerEditorState.currentPaperUnit).toFixed(2);
      let invoiceStickerShapeText = actualStickerShape.charAt(0).toUpperCase() + actualStickerShape.slice(1);
      document.getElementById("invoiceText").value = `Print\nSize : ${artworkDisplayWidth}${stickerEditorState.currentArtworkUnit} x ${artworkDisplayHeight}${stickerEditorState.currentArtworkUnit}\nPaper Size : ${displayPaperWidth}${stickerEditorState.currentPaperUnit} x ${displayPaperHeight}${stickerEditorState.currentPaperUnit}\nMaterial : White Sticker Normal + Kiss Cut\nShape : ${invoiceStickerShapeText}\n* Fit ${actualFitResult.total}pcs in 1pc Paper`;
      document.getElementById("canvasSummaryText").textContent = `${artworkDisplayWidth}${stickerEditorState.currentArtworkUnit} x ${artworkDisplayHeight}${stickerEditorState.currentArtworkUnit} Fit ${actualFitResult.total}pcs in 1pc Paper`;
      const currentArtW = parseFloat(document.getElementById("artworkWidth").value);
      const currentArtH = parseFloat(document.getElementById("artworkHeight").value);
      let matchedPreset = null;
      for (const sizeCm of Object.keys(stickerEditorState.artworkPresets)) {
        const convertedPresetSize = parseFloat(convertFromInches(convertToInches(parseFloat(sizeCm), "cm"), stickerEditorState.currentArtworkUnit).toFixed(1));
        if (Math.abs(currentArtW - convertedPresetSize) < 0.001 && Math.abs(currentArtH - convertedPresetSize) < 0.001) {
          matchedPreset = sizeCm;
          break;
        }
      }
      if (matchedPreset !== null) {
        activatePresetButton(parseFloat(matchedPreset));
      } else {
        document.querySelectorAll('.sticker-editor-wrapper .preset-button').forEach(b => b.classList.remove('active'));
      }
    }

    function drawCanvas(paperW, paperH, artW, artH, horizSpacing, vertSpacing, marginLeft, marginTop, marginRight, marginBottom, stickerShape, layoutMode, usableWidth, usableHeight) {
      const canvas = document.getElementById("layoutCanvas");
      if (!canvas) return {
        total: 0
      };
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const padding = 40,
        targetCanvasWidth = canvas.width - padding * 2,
        targetCanvasHeight = canvas.height - padding * 2;
      const scale = Math.min(targetCanvasWidth / paperW, targetCanvasHeight / paperH);
      const drawnPaperWidth = paperW * scale,
        drawnPaperHeight = paperH * scale;
      const offsetX = (canvas.width - drawnPaperWidth) / 2,
        offsetY = (canvas.height - drawnPaperHeight) / 2;
      ctx.strokeStyle = "#495057";
      ctx.lineWidth = 2;
      ctx.strokeRect(offsetX, offsetY, drawnPaperWidth, drawnPaperHeight);
      const markSize = 4;
      const drawDot = (x, y) => {
        ctx.beginPath();
        ctx.arc(x, y, markSize, 0, 2 * Math.PI);
        ctx.fillStyle = "#000";
        ctx.fill();
      };
      const regMarkOffset = 0.1;
      drawDot(offsetX + (marginLeft * scale) - (regMarkOffset * scale), offsetY + (marginTop * scale) - (regMarkOffset * scale));
      drawDot(offsetX + drawnPaperWidth - (marginRight * scale) + (regMarkOffset * scale), offsetY + (marginTop * scale) - (regMarkOffset * scale));
      drawDot(offsetX + (marginLeft * scale) - (regMarkOffset * scale), offsetY + drawnPaperHeight - (marginBottom * scale) + (regMarkOffset * scale));
      drawDot(offsetX + drawnPaperWidth - (marginRight * scale) + (regMarkOffset * scale), offsetY + drawnPaperHeight - (marginBottom * scale) + (regMarkOffset * scale));
      const usableAreaX = offsetX + (marginLeft * scale),
        usableAreaY = offsetY + (marginTop * scale);
      const usableAreaW = usableWidth * scale,
        usableAreaH = usableHeight * scale;
      ctx.strokeStyle = "#dc3545";
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(usableAreaX, usableAreaY, usableAreaW, usableAreaH);
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(0, 123, 255, 0.7)";
      ctx.strokeStyle = "rgba(0, 0, 0, 0.3)";
      ctx.lineWidth = 0.5;
      const stickersToDraw = [];
      const effectiveArtW = artW + horizSpacing,
        effectiveArtH = artH + vertSpacing;
      const verticalStepOptimized = effectiveArtH * Math.sqrt(3) / 2;
      for (let y = 0;; y++) {
        let currentStickerCenterY = (layoutMode === "optimized" && (stickerShape === "round" || stickerShape === "oval")) ? y * verticalStepOptimized + artH / 2 : y * effectiveArtH + artH / 2;
        if (currentStickerCenterY + artH / 2 > usableHeight + 0.001) break;
        for (let x = 0;; x++) {
          let rowHorizontalShift = (layoutMode === "optimized" && (stickerShape === "round" || stickerShape === "oval") && y % 2 !== 0) ? effectiveArtW / 2 : 0;
          let columnVerticalShift = (layoutMode === "brickByColumn" && x % 2 !== 0) ? effectiveArtH / 2 : 0;
          let currentStickerCenterX = x * effectiveArtW + rowHorizontalShift + artW / 2;
          let currentStickerCenterYWithColumnOffset = currentStickerCenterY + columnVerticalShift;
          if (currentStickerCenterX + artW / 2 > usableWidth + 0.001) break;
          if (currentStickerCenterYWithColumnOffset + artH / 2 > usableHeight + 0.001) {
            if (layoutMode === "brickByColumn") continue;
            else break;
          }
          stickersToDraw.push({
            x: currentStickerCenterX - artW / 2,
            y: currentStickerCenterYWithColumnOffset - artH / 2,
            shape: stickerShape
          });
        }
      }
      let minX = Infinity,
        minY = Infinity,
        maxX = -Infinity,
        maxY = -Infinity;
      if (stickersToDraw.length > 0) {
        stickersToDraw.forEach(s => {
          minX = Math.min(minX, s.x);
          minY = Math.min(minY, s.y);
          maxX = Math.max(maxX, s.x + artW);
          maxY = Math.max(maxY, s.y + artH);
        });
      } else {
        return {
          total: 0
        };
      }
      const totalDrawnGridWidth = (maxX - minX),
        totalDrawnGridHeight = (maxY - minY);
      const centerOffsetX = (usableWidth - totalDrawnGridWidth) / 2,
        centerOffsetY = (usableHeight - totalDrawnGridHeight) / 2;
      stickersToDraw.forEach(sticker => {
        let posX_scaled = usableAreaX + (sticker.x + centerOffsetX) * scale,
          posY_scaled = usableAreaY + (sticker.y + centerOffsetY) * scale;
        let artW_scaled = artW * scale,
          artH_scaled = artH * scale;
        ctx.save();
        ctx.beginPath();
        if (sticker.shape === "square" || sticker.shape === "rectangle") {
          ctx.rect(posX_scaled, posY_scaled, artW_scaled, artH_scaled);
        } else if (sticker.shape === "round" || sticker.shape === "oval") {
          ctx.ellipse(posX_scaled + artW_scaled / 2, posY_scaled + artH_scaled / 2, artW_scaled / 2, artH_scaled / 2, 0, 0, 2 * Math.PI);
        }
        ctx.clip();
        if (stickerEditorState.uploadedImage) {
          let drawImageWidth = artW_scaled,
            drawImageHeight = artH_scaled,
            drawImageX = posX_scaled,
            drawImageY = posY_scaled;
          const imageRatio = stickerEditorState.uploadedImage.width / stickerEditorState.uploadedImage.height,
            stickerRatio = artW / artH;
          if (imageRatio > stickerRatio) {
            drawImageHeight = artH_scaled;
            drawImageWidth = drawImageHeight * imageRatio;
            drawImageX = posX_scaled - (drawImageWidth - artW_scaled) / 2;
          } else {
            drawImageWidth = artW_scaled;
            drawImageHeight = drawImageWidth / imageRatio;
            drawImageY = posY_scaled - (drawImageHeight - artH_scaled) / 2;
          }
          ctx.save();
          if (stickerEditorState.artworkOrientation === 'rotated') {
            const centerX = posX_scaled + artW_scaled / 2,
              centerY = posY_scaled + artH_scaled / 2;
            ctx.translate(centerX, centerY);
            ctx.rotate(Math.PI / 2);
            ctx.drawImage(stickerEditorState.uploadedImage, -drawImageHeight / 2, -drawImageWidth / 2, drawImageHeight, drawImageWidth);
          } else {
            ctx.drawImage(stickerEditorState.uploadedImage, drawImageX, drawImageY, drawImageWidth, drawImageHeight);
          }
          ctx.restore();
        } else {
          ctx.fill();
        }
        ctx.restore();
        ctx.beginPath();
        if (sticker.shape === "square" || sticker.shape === "rectangle") {
          ctx.rect(posX_scaled, posY_scaled, artW_scaled, artH_scaled);
        } else if (sticker.shape === "round" || sticker.shape === "oval") {
          ctx.ellipse(posX_scaled + artW_scaled / 2, posY_scaled + artH_scaled / 2, artW_scaled / 2, artH_scaled / 2, 0, 0, 2 * Math.PI);
        }
        ctx.stroke();
      });
      return {
        total: stickersToDraw.length
      };
    }

    function updatePaperSize() {
      const paperSizeSelect = document.getElementById("paperSize");
      const customPaperDiv = document.getElementById("customPaper");
      if (!paperSizeSelect || !customPaperDiv) return;
      if (paperSizeSelect.value === "custom") {
        customPaperDiv.style.display = "block";
      } else {
        customPaperDiv.style.display = "none";
      }
      calculateLayout();
    }

    function getInputInInches(elementId, type) {
      const el = document.getElementById(elementId);
      if (!el) return 0;
      let value = parseFloat(el.value);
      let unit = type === 'artwork' ? stickerEditorState.currentArtworkUnit : type === 'paper' ? stickerEditorState.currentPaperUnit : stickerEditorState.currentSpacingUnit;
      return convertToInches(value, unit);
    }

    function resetSpacing() {
      const defaultSpacingInCurrentUnit = convertFromInches(convertToInches(0.0, "cm"), stickerEditorState.currentSpacingUnit).toFixed(2);
      document.getElementById("artworkHorizontalSpacing").value = defaultSpacingInCurrentUnit;
      document.getElementById("artworkVerticalSpacing").value = defaultSpacingInCurrentUnit;
      calculateLayout();
    }

    function changeInputValue(elementId, step, type) {
      const input = document.getElementById(elementId);
      let currentValue = parseFloat(input.value) || 0;
      let precision = (type === 'artwork') ? 1 : 2;
      input.value = (currentValue + step).toFixed(precision);
      if (type === 'artwork') {
        updateArtworkDimensions(elementId.includes('Width') ? 'width' : 'height');
      }
      calculateLayout();
    }

    function initStickerEditor() {
      document.getElementById("unitSelect").value = "cm";
      document.getElementById("customUnitSelect").value = "in";
      document.getElementById("spacingUnitSelect").value = "cm";
      stickerEditorState.currentSpacingUnit = "cm";
      document.getElementById("layoutMode").value = "optimized";
      toggleArtworkUnit();
      toggleSpacingUnit();
      updatePaperSizeOptions(stickerEditorState.currentPaperUnit);
      stickerEditorState.originalArtworkDimensions.width = parseFloat(document.getElementById("artworkWidth").value);
      stickerEditorState.originalArtworkDimensions.height = parseFloat(document.getElementById("artworkHeight").value);
      stickerEditorState.lockedAspectRatio = stickerEditorState.originalArtworkDimensions.height > 0 ? stickerEditorState.originalArtworkDimensions.width / stickerEditorState.originalArtworkDimensions.height : 1;
      const initialArtworkWidth = parseFloat(document.getElementById("artworkWidth").value);
      const initialArtworkHeight = parseFloat(document.getElementById("artworkHeight").value);
      if (Math.abs(initialArtworkWidth - initialArtworkHeight) < 0.001) {
        toggleLockRatio(true);
      } else {
        setFreeSize();
      }
      let matchedPresetOnLoad = null;
      for (const sizeCm of Object.keys(stickerEditorState.artworkPresets)) {
        const convertedPresetSize = parseFloat(convertFromInches(convertToInches(parseFloat(sizeCm), "cm"), stickerEditorState.currentArtworkUnit).toFixed(1));
        if (Math.abs(initialArtworkWidth - convertedPresetSize) < 0.001 && Math.abs(initialArtworkHeight - convertedPresetSize) < 0.001) {
          matchedPresetOnLoad = sizeCm;
          break;
        }
      }
      if (matchedPresetOnLoad !== null) {
        applyPresetArtworkSize(parseFloat(matchedPresetOnLoad));
      } else {
        calculateLayout();
      }
      updatePaperSize();
    }

    function renderHomePage(container) {
      const categories = [{
          name: 'Large Format',
          icon: 'fas fa-expand-arrows-alt',
          page: 'largeFormat',
          color: 'from-red-500 to-orange-500'
        },
        {
          name: 'Signboard',
          icon: 'fas fa-sign',
          page: 'signboard',
          color: 'from-blue-500 to-teal-500'
        },
        {
          name: 'Stand',
          icon: 'fas fa-flag',
          page: 'stand',
          color: 'from-purple-500 to-pink-500'
        },
        {
          name: 'Business Card',
          icon: 'fas fa-address-card',
          page: 'businessCard',
          color: 'from-green-500 to-lime-500'
        },
        {
          name: 'Invitation Card',
          icon: 'fas fa-envelope-open-text',
          page: 'invitationCard',
          color: 'from-indigo-500 to-violet-500'
        },
        {
          name: 'Sublimation',
          icon: 'fas fa-tshirt',
          page: 'sublimation',
          color: 'from-yellow-500 to-amber-500'
        },
        {
          name: 'ID Card',
          icon: 'fas fa-id-card',
          page: 'idCard',
          color: 'from-cyan-500 to-sky-500'
        },
        {
          name: 'Sticker Layout',
          icon: 'fas fa-sticky-note',
          page: 'stickerLayout',
          color: 'from-rose-500 to-red-600'
        }
      ];
      let cardsHTML = categories.map(cat => `
    <div class="home-card bg-gradient-to-br ${cat.color}" onclick="loadPage('${cat.page}')" style="box-shadow: 0 10px 25px -5px ${cat.color.split('-')[1]}-400, 0 8px 10px -6px ${cat.color.split('-')[1]}-400;">
      <div class="home-card-icon"><i class="${cat.icon}"></i></div>
      <div class="home-card-title">${cat.name}</div>
    </div>
  `).join('');
      container.innerHTML = `
    <h2 style="text-align: center; font-size: 32px; font-weight: 700;">WELCOME</h2>
    <p style="text-align: center; color: var(--text-secondary); margin-top: -8px; margin-bottom: 24px;">Select a category to start calculating</p>
    <div class="home-grid">${cardsHTML}</div>
  `;
    }
    // =================================================================================
    // SCRIPT FOR PRINTING CALCULATOR
    // =================================================================================
    var lastSearchQueries = {
      largeFormat: "",
      signboard: "",
      stand: ""
    };
    // =================================================================================
    // CURRENCY DATA & STATE
    // =================================================================================
    const currencies = [{
        code: 'MYR',
        symbol: 'RM',
        name: 'Malaysian Ringgit',
        decimal_digits: 2,
        country_code: 'my'
      },
      {
        code: 'USD',
        symbol: '$',
        name: 'United States Dollar',
        decimal_digits: 2,
        country_code: 'us'
      },
      {
        code: 'EUR',
        symbol: '€',
        name: 'Euro',
        decimal_digits: 2,
        country_code: 'eu'
      },
      {
        code: 'JPY',
        symbol: '¥',
        name: 'Japanese Yen',
        decimal_digits: 0,
        country_code: 'jp'
      },
      {
        code: 'IDR',
        symbol: 'Rp',
        name: 'Indonesian Rupiah',
        decimal_digits: 2,
        country_code: 'id'
      },
      {
        code: 'SGD',
        symbol: 'S$',
        name: 'Singapore Dollar',
        decimal_digits: 2,
        country_code: 'sg'
      },
      {
        code: 'GBP',
        symbol: '£',
        name: 'British Pound',
        decimal_digits: 2,
        country_code: 'gb'
      },
      {
        code: 'AUD',
        symbol: 'A$',
        name: 'Australian Dollar',
        decimal_digits: 2,
        country_code: 'au'
      },
      {
        code: 'CAD',
        symbol: '$',
        name: 'Canadian Dollar',
        decimal_digits: 2,
        country_code: 'ca'
      },
      {
        code: 'CHF',
        symbol: 'CHF',
        name: 'Swiss Franc',
        decimal_digits: 2,
        country_code: 'ch'
      },
      {
        code: 'CNY',
        symbol: '¥',
        name: 'Chinese Yuan',
        decimal_digits: 2,
        country_code: 'cn'
      },
      {
        code: 'HKD',
        symbol: '$',
        name: 'Hong Kong Dollar',
        decimal_digits: 2,
        country_code: 'hk'
      },
      {
        code: 'INR',
        symbol: '₹',
        name: 'Indian Rupee',
        decimal_digits: 2,
        country_code: 'in'
      },
      {
        code: 'KRW',
        symbol: '₩',
        name: 'South Korean Won',
        decimal_digits: 0,
        country_code: 'kr'
      },
      {
        code: 'BRL',
        symbol: 'R$',
        name: 'Brazilian Real',
        decimal_digits: 2,
        country_code: 'br'
      },
      {
        code: 'RUB',
        symbol: '₽',
        name: 'Russian Ruble',
        decimal_digits: 2,
        country_code: 'ru'
      },
      {
        code: 'ZAR',
        symbol: 'R',
        name: 'South African Rand',
        decimal_digits: 2,
        country_code: 'za'
      },
      {
        code: 'PHP',
        symbol: '₱',
        name: 'Philippine Peso',
        decimal_digits: 2,
        country_code: 'ph'
      },
      {
        code: 'VND',
        symbol: '₫',
        name: 'Vietnamese Dong',
        decimal_digits: 0,
        country_code: 'vn'
      },
      {
        code: 'AED',
        symbol: 'د.إ',
        name: 'UAE Dirham',
        decimal_digits: 2,
        country_code: 'ae'
      }
    ];
    let currentCurrency = currencies[0]; // Default to MYR
    let tempSelectedCurrencyCode = null;

    function initializeCurrency() {
      const savedCurrencyCode = localStorage.getItem('selectedCurrency');
      if (savedCurrencyCode) {
        const savedCurrency = currencies.find(c => c.code === savedCurrencyCode);
        if (savedCurrency) {
          currentCurrency = savedCurrency;
        }
      }
    }
    initializeCurrency();

    function formatCurrency(amount) {
      if (isNaN(amount)) return '0';
      const formatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: currentCurrency.decimal_digits,
        maximumFractionDigits: currentCurrency.decimal_digits,
      });
      return formatter.format(amount);
    }

    function openCurrencyModal() {
      const list = document.getElementById('currencyList');
      const searchInput = document.getElementById('currencySearch');
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      if (tempSelectedCurrencyCode === null) {
        tempSelectedCurrencyCode = currentCurrency.code;
      }
      const filteredCurrencies = currencies.filter(c =>
        c.name.toLowerCase().includes(searchTerm) ||
        c.code.toLowerCase().includes(searchTerm) ||
        c.symbol.toLowerCase().includes(searchTerm)
      );
      list.innerHTML = filteredCurrencies.map(currency => {
        const isSelected = currency.code === tempSelectedCurrencyCode;
        return `
            <div
                class="flex items-center p-2 rounded-md cursor-pointer hover:bg-gray-100 ${isSelected ? 'bg-blue-100 font-bold text-blue-700' : ''}"
                onclick="previewCurrency('${currency.code}')"
            >
                <img src="https://flagcdn.com/w20/${currency.country_code}.png" srcset="https://flagcdn.com/w40/${currency.country_code}.png 2x" width="20" class="mr-3 rounded-sm" alt="${currency.name} flag">
                <span class="w-8 text-center text-gray-500 ${isSelected ? 'text-blue-700' : ''}">${currency.symbol}</span>
                <span class="flex-1 ml-2">${currency.name}</span>
                <span class="text-gray-400 font-mono ${isSelected ? 'text-blue-600' : ''}">${currency.code}</span>
            </div>
        `;
      }).join('');
      if (document.getElementById('currencyModal').style.display !== 'flex') {
        document.getElementById('currencyModal').style.display = 'flex';
      }
    }

    function closeCurrencyModal() {
      document.getElementById('currencyModal').style.display = 'none';
    }

    function previewCurrency(code) {
      tempSelectedCurrencyCode = code;
      document.getElementById('saveCurrencyBtn').disabled = false;
      openCurrencyModal();
    }

    function selectCurrency() {
      const newCurrency = currencies.find(c => c.code === tempSelectedCurrencyCode);
      if (newCurrency) {
        currentCurrency = newCurrency;
        localStorage.setItem('selectedCurrency', tempSelectedCurrencyCode);
        closeCurrencyModal();
        tempSelectedCurrencyCode = null;
        document.getElementById('saveCurrencyBtn').disabled = true;
        if (currentCategory === 'settings') {
          renderSettingsPage(document.getElementById('contentArea'));
        } else {
          loadPage(currentCategory);
        }
      }
    }
    // =================================================================================
    // TAX DATA & STATE
    // =================================================================================
    let isTaxEnabled = false;
    let globalTaxPercent = 6; // Default to 6%
    function initializeTaxSettings() {
      const savedTaxEnabled = localStorage.getItem('isTaxEnabled');
      const savedTaxPercent = localStorage.getItem('globalTaxPercent');
      if (savedTaxEnabled !== null) {
        isTaxEnabled = savedTaxEnabled === 'true';
      }
      if (savedTaxPercent !== null) {
        globalTaxPercent = parseFloat(savedTaxPercent);
      }
    }
    initializeTaxSettings(); // Call this function once when the script loads
    let glueExceptionSizes = [];
    let eyeletExceptionSizes = [];

    function initializeGlueExceptions() {
      // This list has been optimized to remove redundant and overlapping sizes.
      // The logic checks if a banner's dimensions are less than or equal to ANY of these pairs.
      glueExceptionSizes = [
        [2, 6], // Covers all sizes up to 2ft x 6ft (including 1x1, 1x2, etc.)
        [3, 4], // Covers 3x1, 3x2, 3x3, 3x4 and their rotations (4x1, 4x2, 4x3)
        [4, 4], // Covers the specific 4x4 size
        [5, 2] // Covers 5x1, 5x2 and their rotations
      ];
    }
    // ADD THIS CALL
    initializeGlueExceptions();

    function initializeEyeletExceptions() {
      const savedSizes = localStorage.getItem('eyeletExceptionSizes');
      if (savedSizes) {
        try {
          eyeletExceptionSizes = JSON.parse(savedSizes);
        } catch (e) {
          console.error("Error parsing eyeletExceptionSizes from localStorage", e);
          eyeletExceptionSizes = [
            [1, 1],
            [1, 2],
            [3, 1],
            [3, 2],
            [3, 3],
            [3, 4],
            [4, 1],
            [4, 2],
            [4, 3],
            [4, 4],
            [5, 1],
            [5, 2],
            [6, 1],
            [6, 2]
          ];
        }
      } else {
        // If no sizes are saved, initialize with the original hardcoded list.
        eyeletExceptionSizes = [
          [1, 1],
          [1, 2],
          [3, 1],
          [3, 2],
          [3, 3],
          [3, 4],
          [4, 1],
          [4, 2],
          [4, 3],
          [4, 4],
          [5, 1],
          [5, 2],
          [6, 1],
          [6, 2]
        ];
      }
    }
    initializeEyeletExceptions();
    const a_sizes_mm = {
      'A0': {
        w: 841,
        h: 1189
      },
      'A1': {
        w: 594,
        h: 841
      },
      'A2': {
        w: 420,
        h: 594
      },
      'A3': {
        w: 297,
        h: 420
      },
      'A4': {
        w: 210,
        h: 297
      },
      'A5': {
        w: 148,
        h: 210
      },
      'A6': {
        w: 105,
        h: 148
      }
    };

    function isExceptionSize(w, h) {
      return eyeletExceptionSizes.some(([a, b]) => (w <= a && h <= b) || (w <= b && h <= a));
    }
    var materials = [{
      name: 'Tarpaulin Normal 320gsm',
      customerPrice: 2.50,
      agentPrice: 1.50,
      simple: false
    }, {
      name: 'Tarpaulin UV 440gsm',
      customerPrice: 5.00,
      agentPrice: 4.00,
      simple: false
    }, {
      name: 'White Sticker Normal',
      customerPrice: 5.00,
      agentPrice: 4.00,
      simple: true
    }, {
      name: 'White Sticker  + Cold Laminate',
      customerPrice: 9.00,
      agentPrice: 8.00,
      simple: true
    }, {
      name: 'White Sticker Normal + Kiss Cut',
      customerPrice: 6.7,
      agentPrice: 6.00,
      simple: true
    }, {
      name: 'White Sticker Normal + Kiss Cut + Hot Laminate',
      customerPrice: 8.40,
      agentPrice: 7.40,
      simple: true
    }, {
      name: 'White Sticker Normal + Kiss Cut + Cold Laminate',
      customerPrice: 11.40,
      agentPrice: 10.40,
      simple: true
    }, {
      name: 'White Sticker UV',
      customerPrice: 6.50,
      agentPrice: 5.50,
      simple: true
    }, {
      name: 'Sticker Transparent UV',
      customerPrice: 8.00,
      agentPrice: 7.00,
      simple: true
    }, {
      name: 'Sticker Solid Cut Out',
      customerPrice: 12.00,
      agentPrice: 10.00,
      simple: true
    }, {
      name: 'Sticker Chrome Cut Out',
      customerPrice: 15.00,
      agentPrice: 12.00,
      simple: true
    }, {
      name: 'One Way Sticker UV',
      customerPrice: 9.50,
      agentPrice: 8.00,
      simple: true
    }, {
      name: 'Backlit Film UV',
      customerPrice: 11.00,
      agentPrice: 10.00,
      simple: true
    }, {
      name: 'Synthetic Paper Normal',
      customerPrice: 6.00,
      agentPrice: 5.00,
      simple: false
    }, {
      name: 'Synthetic Paper UV',
      customerPrice: 7.00,
      agentPrice: 6.00,
      simple: false
    }, {
      name: 'Polysilk Normal',
      customerPrice: 6.00,
      agentPrice: 5.50,
      simple: true
    }, {
      name: 'Art Canvas UV',
      customerPrice: 7.50,
      agentPrice: 6.50,
      simple: true
    }, {
      name: 'White Sticker UV + Magnet Sheet 0.5mm',
      customerPrice: 25.00,
      agentPrice: 23.00,
      agent: false,
      simple: true
    }, {
      name: 'Roll Up Stand + Synthetic Paper Normal',
      customerPrice: 11.85,
      agentPrice: 10.55,
      agent: false,
      simple: true,
      fixed: true,
      fixedWidth: 2.5,
      fixedHeight: 6.5
    }, {
      name: 'Roll Up Stand + Synthetic Paper UV',
      customerPrice: 12.85,
      agentPrice: 11.55,
      agent: false,
      simple: true,
      fixed: true,
      fixedWidth: 2.5,
      fixedHeight: 6.5
    }, {
      name: 'Jumbo Stand + Tarpaulin Normal',
      customerPrice: 8.15,
      agentPrice: 6.65,
      agent: false,
      simple: true,
      fixed: true,
      fixedWidth: 8.0,
      fixedHeight: 8.0
    }, {
      name: 'PVC Promotion Counter + White Sticker Normal',
      customerPrice: 21.80,
      agentPrice: 19.20,
      agent: false,
      simple: true,
      fixed: true,
      fixedWidth: 6.92,
      fixedHeight: 2.67
    }, ];
    var stands = [{
      name: "X-Stand",
      customerPrice: 35,
      agentPrice: 30,
      agent: false
    }, {
      name: "T-Stand",
      customerPrice: 40,
      agentPrice: 35,
      agent: false
    }, {
      name: "Easel Stand",
      customerPrice: 85,
      agentPrice: 80,
      agent: false
    }, {
      name: "Roll Up Stand",
      customerPrice: 95,
      agentPrice: 90,
      agent: false
    }, {
      name: "Jumbo Stand (Sell Only)",
      customerPrice: 360,
      agentPrice: 330,
      agent: false
    }, {
      name: "PVC Promotion Counter Blank",
      customerPrice: 260,
      agentPrice: 230,
      agent: false
    }];
    var signboardMaterials = [{
      name: "White Sticker Normal + Compress Foam Board",
      customerPrice: 9.50,
      agentPrice: 7.00,
      simple: true
    }, {
      name: "White Sticker Normal + Compress Foam Board + Die Cut Shape",
      customerPrice: 12.50,
      agentPrice: 9.00,
      simple: true
    }, {
      name: "White Sticker UV + Compress Foam Board",
      customerPrice: 11.00,
      agentPrice: 8.50,
      simple: true
    }, {
      name: "White Sticker Normal + PP Board",
      customerPrice: 10.00,
      agentPrice: 7.50,
      simple: true
    }, {
      name: "White Sticker UV + PP Board",
      customerPrice: 11.50,
      agentPrice: 9.00,
      simple: true
    }, {
      name: "White Sticker UV + Polycarbonate",
      customerPrice: 20.00,
      agentPrice: 17.00,
      simple: true
    }];
    var sublimationVariations = [{
      label: "Collar Button",
      cost: 5.00
    }, {
      label: "Collar Zip",
      cost: 5.00
    }, {
      label: "Long Sleeve",
      cost: 4.00
    }, {
      label: "Muslimah",
      cost: 6.00
    }, {
      label: "Nameset Customization",
      cost: 2.00
    }, {
      label: "Retro-Neck",
      cost: 5.00
    }, {
      label: "Mandarin-Neck + Button",
      cost: 5.00
    }, {
      label: "Mandarin-Neck + Zip",
      cost: 5.00
    }, {
      label: "V-Neck",
      cost: 4.00
    }, ];
    var extraSizeCost = {
      "3XL": 5.00,
      "4XL": 6.00,
      "5XL": 7.00,
      "6XL": 8.00,
      "7XL": 10.00,
      "8XL": 12.00
    };
    var invitationCardData = {
      basePrice: {
        A6: {
          30: {
            1: 2.00,
            2: 2.20
          },
          50: {
            1: 1.50,
            2: 1.80
          },
          100: {
            1: 1.00,
            2: 1.10
          },
          200: {
            1: 0.60,
            2: 0.70
          },
          500: {
            1: 0.55,
            2: 0.65
          },
          1000: {
            1: 0.45,
            2: 0.55
          }
        },
        DL: {
          30: {
            1: 2.20,
            2: 2.60
          },
          50: {
            1: 1.90,
            2: 2.30
          },
          100: {
            1: 1.50,
            2: 1.55
          },
          200: {
            1: 0.85,
            2: 0.90
          },
          500: {
            1: 0.70,
            2: 0.80
          },
          1000: {
            1: 0.55,
            2: 0.70
          }
        },
        A5: {
          30: {
            1: 2.30,
            2: 3.00
          },
          50: {
            1: 1.80,
            2: 2.00
          },
          100: {
            1: 1.45,
            2: 1.60
          },
          200: {
            1: 0.70,
            2: 0.80
          },
          500: {
            1: 0.65,
            2: 0.75
          },
          1000: {
            1: 0.50,
            2: 0.65
          }
        },
        A4: {
          30: {
            1: 2.50,
            2: 4.00
          },
          50: {
            1: 2.00,
            2: 2.40
          },
          100: {
            1: 1.60,
            2: 1.80
          },
          200: {
            1: 1.00,
            2: 1.20
          },
          500: {
            1: 0.80,
            2: 1.00
          },
          1000: {
            1: 0.70,
            2: 0.90
          }
        },
        A3: {
          30: {
            1: 3.00,
            2: 6.00
          },
          50: {
            1: 2.90,
            2: 3.60
          },
          100: {
            1: 2.40,
            2: 3.00
          },
          200: {
            1: 2.00,
            2: 2.60
          },
          500: {
            1: 1.60,
            2: 2.00
          },
          1000: {
            1: 1.20,
            2: 1.60
          }
        }
      },
      materialAddOn: {
        A6: {
          'Simili 80gsm': 0.00,
          'Simili 100gsm': 0.05,
          'Simili 140gsm': 0.05,
          'Art Paper 105gsm': 0.05,
          'Art Paper 128gsm': 0.05,
          'Art Paper 157gsm': 0.10,
          'Art Card 260gsm': 0.15,
          'Art Card 300gsm': 0.20,
          'Ivory Card 230gsm': 0.20,
          'Ivory Card 300gsm': 0.25,
          'Taiga Card 320gsm': 0.40,
          'Laid Paper 100gsm': 0.15,
          'Laid Card 230gsm': 0.55,
          'Linen Card 250gsm': 0.40,
          'King Pearl Card 250gsm': 0.40,
          'King Pearl Card 300gsm': 0.45,
          'Synthetic Paper 130mic': 0.15,
          'Synthetic Paper 210mic': 2.00,
          'Kraft Paper 120gsm': 0.15,
          'Kraft Paper 250gsm': 0.30,
          'Kraft Paper 300gsm': 0.30
        },
        DL: {
          'Simili 80gsm': 0.00,
          'Simili 100gsm': 0.05,
          'Simili 140gsm': 0.05,
          'Art Paper 105gsm': 0.05,
          'Art Paper 128gsm': 0.05,
          'Art Paper 157gsm': 0.10,
          'Art Card 260gsm': 0.20,
          'Art Card 300gsm': 0.25,
          'Ivory Card 230gsm': 0.25,
          'Ivory Card 300gsm': 0.30,
          'Taiga Card 320gsm': 0.50,
          'Laid Paper 100gsm': 0.15,
          'Laid Card 230gsm': 0.60,
          'Linen Card 250gsm': 0.50,
          'King Pearl Card 250gsm': 0.50,
          'King Pearl Card 300gsm': 0.55,
          'Synthetic Paper 130mic': 0.20,
          'Synthetic Paper 210mic': 2.30,
          'Kraft Paper 120gsm': 0.15,
          'Kraft Paper 250gsm': 0.30,
          'Kraft Paper 300gsm': 0.35
        },
        A5: {
          'Simili 80gsm': 0.00,
          'Simili 100gsm': 0.05,
          'Simili 140gsm': 0.10,
          'Art Paper 105gsm': 0.05,
          'Art Paper 128gsm': 0.05,
          'Art Paper 157gsm': 0.10,
          'Art Card 260gsm': 0.20,
          'Art Card 300gsm': 0.30,
          'Ivory Card 230gsm': 0.30,
          'Ivory Card 300gsm': 0.40,
          'Taiga Card 320gsm': 0.65,
          'Laid Paper 100gsm': 0.20,
          'Laid Card 230gsm': 0.80,
          'Linen Card 250gsm': 0.60,
          'King Pearl Card 250gsm': 0.60,
          'King Pearl Card 300gsm': 0.65,
          'Synthetic Paper 130mic': 2.00,
          'Synthetic Paper 210mic': 3.00,
          'Kraft Paper 120gsm': 0.30,
          'Kraft Paper 250gsm': 0.40,
          'Kraft Paper 300gsm': 0.50
        },
        A4: {
          'Simili 80gsm': 0.00,
          'Simili 100gsm': 0.10,
          'Simili 140gsm': 0.10,
          'Art Paper 105gsm': 0.10,
          'Art Paper 128gsm': 0.10,
          'Art Paper 157gsm': 0.15,
          'Art Card 260gsm': 0.40,
          'Art Card 300gsm': 0.50,
          'Ivory Card 230gsm': 0.55,
          'Ivory Card 300gsm': 0.70,
          'Taiga Card 320gsm': 1.25,
          'Laid Paper 100gsm': 0.35,
          'Laid Card 230gsm': 1.60,
          'Linen Card 250gsm': 1.20,
          'King Pearl Card 250gsm': 1.20,
          'King Pearl Card 300gsm': 1.30,
          'Synthetic Paper 130mic': 4.00,
          'Synthetic Paper 210mic': 6.00,
          'Kraft Paper 120gsm': 0.40,
          'Kraft Paper 250gsm': 0.80,
          'Kraft Paper 300gsm': 0.90
        },
        A3: {
          'Simili 80gsm': 0.00,
          'Simili 100gsm': 0.10,
          'Simili 140gsm': 0.20,
          'Art Paper 105gsm': 0.10,
          'Art Paper 128gsm': 0.20,
          'Art Paper 157gsm': 0.30,
          'Art Card 260gsm': 0.75,
          'Art Card 300gsm': 1.00,
          'Ivory Card 230gsm': 1.10,
          'Ivory Card 300gsm': 1.40,
          'Taiga Card 320gsm': 2.45,
          'Laid Paper 100gsm': 0.70,
          'Laid Card 230gsm': 3.15,
          'Linen Card 250gsm': 2.40,
          'King Pearl Card 250gsm': 2.40,
          'King Pearl Card 300gsm': 2.60,
          'Synthetic Paper 130mic': 8.00,
          'Synthetic Paper 210mic': 12.00,
          'Kraft Paper 120gsm': 0.70,
          'Kraft Paper 250gsm': 1.60,
          'Kraft Paper 300gsm': 1.80
        }
      },
      addons: [{
        name: "Lamination",
        options: [{
            name: "None",
            prices: {
              A6: 0.00,
              DL: 0.00,
              A5: 0.00,
              A4: 0.00,
              A3: 0.00
            }
          },
          {
            name: "Matte",
            prices: {
              A6: 0.20,
              DL: 0.25,
              A5: 0.30,
              A4: 0.50,
              A3: 1.00
            }
          },
          {
            name: "Glossy",
            prices: {
              A6: 0.30,
              DL: 0.35,
              A5: 0.40,
              A4: 0.60,
              A3: 1.20
            }
          },
        ]
      }],
      quantities: [30, 50, 100, 200, 500, 1000],
      materials: ["Simili 80gsm", "Simili 100gsm", "Simili 140gsm", "Art Paper 105gsm", "Art Paper 128gsm", "Art Paper 157gsm", "Art Card 260gsm", "Art Card 300gsm", "Ivory Card 230gsm", "Ivory Card 300gsm", "Taiga Card 320gsm", "Laid Paper 100gsm", "Laid Card 230gsm", "Linen Card 250gsm", "King Pearl Card 250gsm", "King Pearl Card 300gsm", "Synthetic Paper 130mic", "Synthetic Paper 210mic", "Kraft Paper 120gsm", "Kraft Paper 250gsm", "Kraft Paper 300gsm"],
      sizes: ["A6", "DL", "A5", "A4", "A3"]
    };
    var idCardRates = [{
      qty: 1,
      unitPrice: 25.0
    }, {
      qty: 2,
      unitPrice: 20.0
    }, {
      qty: 3,
      unitPrice: 18.0
    }, {
      qty: 4,
      unitPrice: 16.0
    }, {
      qty: 5,
      unitPrice: 14.0
    }, {
      qty: 10,
      unitPrice: 12.0
    }, {
      qty: 20,
      unitPrice: 10.0
    }, {
      qty: 40,
      unitPrice: 8.0
    }];
    var businessCardData = {
      quantities: [{
        label: "2 Box",
        value: 2
      }, {
        label: "5 Boxes",
        value: 5
      }, {
        label: "10 Boxes",
        value: 10
      }],
      materials: [{
        name: 'Art Card 260gsm',
        p1: {
          2: 22,
          5: 19.8,
          10: 18.5
        },
        p2: {
          2: 25,
          5: 21.8,
          10: 21.5
        }
      }, {
        name: 'Art Card 300gsm',
        p1: {
          2: 23,
          5: 22.8,
          10: 21.5
        },
        p2: {
          2: 25,
          5: 24.8,
          10: 24.5
        }
      }, {
        name: 'Ivory Card 230gsm',
        p1: {
          2: 26,
          5: 25.8,
          10: 24.5
        },
        p2: {
          2: 28,
          5: 27.8,
          10: 27.5
        }
      }, {
        name: 'King Pearl Card 250gsm',
        p1: {
          2: 40,
          5: 38,
          10: 37
        },
        p2: {
          2: 42,
          5: 40,
          10: 39
        }
      }, {
        name: 'Linen Card 250gsm',
        p1: {
          2: 40,
          5: 38,
          10: 37
        },
        p2: {
          2: 42,
          5: 40,
          10: 39
        }
      }, {
        name: 'Laid Card 250gsm',
        p1: {
          2: 40,
          5: 38,
          10: 37
        },
        p2: {
          2: 42,
          5: 40,
          10: 39
        }
      }],
      addons: [{
        name: "Finishing",
        options: [{
          name: 'None',
          price: 0
        }, {
          name: 'Matte Lamination',
          price: 14
        }, {
          name: 'Gloss Lamination',
          price: 19
        }]
      }, {
        name: "Round Corner",
        options: [{
          name: 'None',
          value: 'none',
          price: 0
        }, {
          name: 'All 4 Corners',
          value: 'all',
          price: 5
        }]
      }, {
        name: "Spot UV",
        options: [{
          name: 'None',
          value: 'none',
          price: 0
        }, {
          name: '1 Side',
          value: '1',
          price: 40
        }, {
          name: '2 Sides',
          value: '2',
          price: 60
        }]
      }],
      printSides: [{
        label: '1 Side',
        value: 1
      }, {
        label: '2 Sides',
        value: 2
      }]
    };
    var globalEyeletPrice = 0.50,
      globalGluePrice = 1.00,
      globalPipePrice = 3.00,
      globalGovSurchargePercent = 40,
      selectedMaterialIndex = null,
      pricePerSqFt = 0,
      isStickerOrPolysilk = false,
      currentInputUnit = 'ft',
      currentCategory = "largeFormat",
      editingIndex = -1,
      selectedSublimationQty = 10,
      selectedIdCardQty = 10,
      selectedInvCardMaterial = 0,
      selectedBc = {
        qty: 2,
        material: 0,
        printSide: 2,
        selectedAddons: [0, 0, 0] // Matches the initial state of the addons array
      };
    // State for invitation card settings edit mode
    var invitationCardEditState = {
      base: false,
      material: false,
      addons: [] // will be populated with boolean flags
    };
    var originalInvitationCardData = {};
    var businessCardEditState = {
      materials: false,
      addons: [] // will be populated with boolean flags
    };
    var originalBusinessCardData = {};
    let lastClickedASize = null;

    function renderGlueExceptionTable() {
      const container = document.getElementById('glueExceptionTableContainer');
      if (!container) return;
      let tableHTML = `<table class="settings-table"><thead><tr><th>Width (ft)</th><th>Height (ft)</th><th>Action</th></tr></thead><tbody>`;
      if (glueExceptionSizes.length === 0) {
        tableHTML += `<tr><td colspan="3" class="text-center text-gray-500">No exception sizes defined.</td></tr>`;
      } else {
        glueExceptionSizes.forEach((size, index) => {
          tableHTML += `<tr><td class="text-center">${size[0]}</td><td class="text-center">${size[1]}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteGlueExceptionSize(${index})">Delete</button></td></tr>`;
        });
      }
      tableHTML += `</tbody></table>`;
      container.innerHTML = tableHTML;
    }

    function addGlueExceptionSize() {
      const wInput = document.getElementById('glueExceptionW');
      const hInput = document.getElementById('glueExceptionH');
      const w = parseFloat(wInput.value);
      const h = parseFloat(hInput.value);
      if (isNaN(w) || isNaN(h) || w <= 0 || h <= 0) {
        alert("Please enter a valid width and height.");
        return;
      }
      glueExceptionSizes.push([w, h]);
      localStorage.setItem('glueExceptionSizes', JSON.stringify(glueExceptionSizes));
      renderGlueExceptionTable(); // Refresh the table
      wInput.value = '';
      hInput.value = '';
    }

    function deleteGlueExceptionSize(index) {
      if (confirm("Are you sure you want to delete this exception size?")) {
        glueExceptionSizes.splice(index, 1);
        localStorage.setItem('glueExceptionSizes', JSON.stringify(glueExceptionSizes));
        renderGlueExceptionTable(); // Refresh the table
      }
    }

    function renderEyeletExceptionTable() {
      const container = document.getElementById('eyeletExceptionTableContainer');
      if (!container) return;
      let tableHTML = `<table class="settings-table"><thead><tr><th>Width (ft)</th><th>Height (ft)</th><th>Action</th></tr></thead><tbody>`;
      if (eyeletExceptionSizes.length === 0) {
        tableHTML += `<tr><td colspan="3" class="text-center text-gray-500">No exception sizes defined.</td></tr>`;
      } else {
        eyeletExceptionSizes.forEach((size, index) => {
          tableHTML += `<tr><td class="text-center">${size[0]}</td><td class="text-center">${size[1]}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteEyeletExceptionSize(${index})">Delete</button></td></tr>`;
        });
      }
      tableHTML += `</tbody></table>`;
      container.innerHTML = tableHTML;
    }

    function addEyeletExceptionSize() {
      const wInput = document.getElementById('eyeletExceptionW');
      const hInput = document.getElementById('eyeletExceptionH');
      const w = parseFloat(wInput.value);
      const h = parseFloat(hInput.value);
      if (isNaN(w) || isNaN(h) || w <= 0 || h <= 0) {
        alert("Please enter a valid width and height.");
        return;
      }
      eyeletExceptionSizes.push([w, h]);
      localStorage.setItem('eyeletExceptionSizes', JSON.stringify(eyeletExceptionSizes));
      renderEyeletExceptionTable();
      wInput.value = '';
      hInput.value = '';
    }

    function deleteEyeletExceptionSize(index) {
      if (confirm("Are you sure you want to delete this exception size?")) {
        eyeletExceptionSizes.splice(index, 1);
        localStorage.setItem('eyeletExceptionSizes', JSON.stringify(eyeletExceptionSizes));
        renderEyeletExceptionTable();
      }
    }

    function convertToFeetCalc(value, unit) {
      switch (unit) {
        case "mm":
          return value * 0.00328084;
        case "cm":
          return value * 0.0328084;
        case "in":
          return value / 12.0;
        case "m":
          return value * 3.28084;
        default:
          return value;
      }
    }

    function convertFromMm(valueMm, unit) {
      switch (unit) {
        case 'mm':
          return valueMm;
        case 'cm':
          return valueMm / 10;
        case 'in':
          return valueMm / 25.4;
        case 'm':
          return valueMm / 1000;
        case 'ft':
          return valueMm * 0.00328084;
        default:
          return valueMm;
      }
    }

    function convertToMm(val, unit) {
      switch (unit) {
        case 'mm':
          return val;
        case 'cm':
          return val * 10;
        case 'in':
          return val * 25.4;
        case 'm':
          return val * 1000;
        case 'ft':
          return val / 0.00328084;
        default:
          return val;
      }
    }

    function isGamExemptedSize(w, h) {
      if (!glueExceptionSizes || glueExceptionSizes.length === 0) {
        return false;
      }
      return glueExceptionSizes.some(([exceptW, exceptH]) =>
        (w <= exceptW && h <= exceptH) || (w <= exceptH && h <= exceptW)
      );
    }

    function autoEyelet(w, h) {
      if (isExceptionSize(w, h)) return 4;
      var topCount = Math.round(w / 2);
      var bottomCount = Math.round(w / 3);
      var sideEach = (h > 2.5 && h <= 3) ? 1 : (h > 3 && h <= 4) ? 2 : (h > 4) ? 2 : 0;
      var interiorTop = topCount > 0 ? topCount - 1 : 0;
      var interiorBottom = bottomCount > 0 ? bottomCount - 1 : 0;
      return interiorTop + interiorBottom + (sideEach * 2) + 4;
    }

    function copyInvoiceText() {
      const textArea = document.getElementById('invoiceText');
      const copyBtn = document.getElementById('copyBtn');
      if (!textArea || !copyBtn) return;
      textArea.select();
      navigator.clipboard.writeText(textArea.value).then(() => {
        const originalText = copyBtn.innerText;
        copyBtn.innerText = 'Copied!';
        copyBtn.disabled = true;
        setTimeout(() => {
          copyBtn.innerText = originalText;
          copyBtn.disabled = false;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }

    function filterMaterials(type) {
      const input = document.getElementById('materialSearch');
      const filter = input.value.toUpperCase();
      const grid = document.getElementById(`material-grid-${type}`);
      const cards = grid.getElementsByClassName('material-card');
      for (let i = 0; i < cards.length; i++) {
        const title = cards[i].getElementsByTagName("strong")[0];
        if (title.innerText.toUpperCase().indexOf(filter) > -1) {
          cards[i].style.display = "";
        } else {
          cards[i].style.display = "none";
        }
      }
    }

    function filterStands() {
      const input = document.getElementById('standSearch');
      const filter = input.value.toUpperCase();
      const grid = document.getElementById('stand-grid');
      const cards = grid.getElementsByClassName('material-card');
      for (let i = 0; i < cards.length; i++) {
        const title = cards[i].getElementsByTagName("strong")[0];
        if (title.innerText.toUpperCase().indexOf(filter) > -1) {
          cards[i].style.display = "";
        } else {
          cards[i].style.display = "none";
        }
      }
    }

    function loadPage(page) {
      const navLinks = document.querySelectorAll('#drawer-navigation a');
      navLinks.forEach(link => {
        link.classList.remove('sidebar-active');
      });
      const activeLink = document.querySelector(`#drawer-navigation a[onclick="loadPage('${page}');"]`);
      if (activeLink) {
        activeLink.classList.add('sidebar-active');
      }
      // No active class management needed for drawer links
      const content = document.getElementById('contentArea');
      selectedMaterialIndex = null;
      currentCategory = page;
      if (page === 'invitationCard') {
        // Initialize the selected addons state, defaulting to the first option (index 0) for each
        selectedInvCardAddons = invitationCardData.addons.map(() => 0);
      }
      switch (page) {
        case 'home':
          renderHomePage(content);
          break;
        case 'largeFormat':
          renderMaterialGrid(content, 'largeFormat');
          break;
        case 'signboard':
          renderMaterialGrid(content, 'signboard');
          break;
        case 'stand':
          renderStandGrid(content);
          break;
        case 'businessCard':
          renderBusinessCardPage(content);
          break;
        case 'invitationCard':
          renderInvitationCardCalculator(content);
          break;
        case 'sublimation':
          renderSublimationCalculator(content);
          break;
        case 'idCard':
          renderIDCardCalculator(content);
          break;
        case 'stickerLayout':
          renderStickerLayoutEditor(content);
          break;
        case 'settings':
          renderSettingsPage(content);
          break;
        default:
          content.innerHTML = `<h2>${page.charAt(0).toUpperCase() + page.slice(1)}</h2><p>Calculator coming soon.</p>`;
      }
    }

    function renderStickerLayoutEditor(container) {
      container.innerHTML = `
        <div class="sticker-editor-wrapper">
            <div class="container">
                <h2>STICKER LAYOUT EDITOR</h2>
                <label for="paperSize">Paper Size:</label>
                <select id="paperSize" onchange="updatePaperSize()">
                    <option value="11.7,16.5">A3 (11.7inch x 16.5inch)</option>
                    <option value="12,18" selected>12inch x 18inch</option>
                    <option value="12,18.5">12inch x 18.5inch</option>
                    <option value="12,19">12inch x 19inch</option>
                    <option value="13,19">13inch x 19inch</option>
                    <option value="custom">Custom Size</option>
                </select>
                <div id="customPaper" style="display: none;">
                    <div class="row">
                        <div><label for="paperWidth">Paper Width:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('paperWidth', -1, 'paper')"><i class="fas fa-minus"></i></button><input type="number" id="paperWidth" step="1" value="12" onchange="calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('paperWidth', 1, 'paper')"><i class="fas fa-plus"></i></button></div></div>
                        <div><label for="paperHeight">Paper Height:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('paperHeight', -1, 'paper')"><i class="fas fa-minus"></i></button><input type="number" id="paperHeight" step="1" value="18" onchange="calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('paperHeight', 1, 'paper')"><i class="fas fa-plus"></i></button></div></div>
                        <div><label for="customUnitSelect">Paper Unit:</label><select id="customUnitSelect" onchange="toggleCustomPaperUnit()"><option value="in">inch</option><option value="cm">cm</option><option value="mm">mm</option><option value="ft">feet</option></select></div>
                    </div>
                    <span class="info-text general-info-text">Enter custom paper dimensions in the selected unit.</span>
                </div>
                <div class="row">
                    <div><label for="artworkWidth">Artwork Width:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('artworkWidth', -1, 'artwork')"><i class="fas fa-minus"></i></button><input type="number" id="artworkWidth" step="1" value="5.0" onchange="updateArtworkDimensions('width'); calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('artworkWidth', 1, 'artwork')"><i class="fas fa-plus"></i></button></div></div>
                    <div><label for="artworkHeight">Artwork Height:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('artworkHeight', -1, 'artwork')"><i class="fas fa-minus"></i></button><input type="number" id="artworkHeight" step="1" value="5.0" onchange="updateArtworkDimensions('height'); calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('artworkHeight', 1, 'artwork')"><i class="fas fa-plus"></i></button></div></div>
                    <div><label for="unitSelect">Artwork Unit:</label><div class="artwork-unit-controls"><select id="unitSelect" onchange="toggleArtworkUnit()"><option value="in">inch</option><option value="cm" selected>cm</option><option value="mm">mm</option><option value="ft">feet</option></select><button class="btn btn-control" onclick="rotateArtwork()"><i class="fas fa-sync-alt"></i></button></div></div>
                </div>
                <span class="info-text general-info-text">Enter artwork dimensions in the selected unit.</span>
                <div class="row" style="margin-top: -15px; margin-bottom: 25px; gap: 10px;">
                    <div style="flex: none; width: auto;"><button id="lockRatioBtn" class="btn btn-control" onclick="toggleLockRatio()">Lock Ratio</button></div>
                    <div style="flex: none; width: auto;"><button id="freeSizeBtn" class="btn btn-control" onclick="setFreeSize()">Free Size</button></div>
                    <div style="flex: none; width: auto;"><button id="revertBtn" class="btn btn-control" onclick="revertToOriginalSize()">Revert To Original</button></div>
                    <div style="flex: none; width: auto;"><button id="resizeToFitBtn" class="btn btn-control" onclick="resizeArtworkToFitPaper()">Resize To Fit Paper</button></div>
                </div>
                <div class="artwork-control-grid">
                    <div class="artwork-presets-column"><label>Artwork Presets:</label><div class="preset-buttons-container"><button class="preset-button" onclick="applyPresetArtworkSize(1)">1cm</button><button class="preset-button" onclick="applyPresetArtworkSize(2)">2cm</button><button class="preset-button" onclick="applyPresetArtworkSize(3)">3cm</button><button class="preset-button" onclick="applyPresetArtworkSize(4)">4cm</button><button class="preset-button" onclick="applyPresetArtworkSize(5)">5cm</button><button class="preset-button" onclick="applyPresetArtworkSize(6)">6cm</button><button class="preset-button" onclick="applyPresetArtworkSize(7)">7cm</button><button class="preset-button" onclick="applyPresetArtworkSize(8)">8cm</button><button class="preset-button" onclick="applyPresetArtworkSize(9)">9cm</button><button class="preset-button" onclick="applyPresetArtworkSize(10)">10cm</button></div></div>
                    <div class="file-upload-group artwork-upload-column"><label for="artworkImage">Upload Artwork:</label><div class="file-input-wrapper"><input type="file" id="artworkImage" accept="image/*" onchange="handleImageUpload();" style="display: none;"><label for="artworkImage" class="custom-file-upload-button">Choose File</label><span id="fileNameDisplay" class="file-name-display">No file chosen</span></div><div class="clear-image-controls"><button class="btn btn-control" onclick="clearUploadedImage()">Clear Image</button><span class="info-text">Upload to see it on the stickers.</span></div></div>
                </div>
                <div class="row">
                    <div><label for="artworkHorizontalSpacing">Horizontal Spacing:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('artworkHorizontalSpacing', -0.1, 'spacing')"><i class="fas fa-minus"></i></button><input type="number" id="artworkHorizontalSpacing" step="0.1" value="0" onchange="calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('artworkHorizontalSpacing', 0.1, 'spacing')"><i class="fas fa-plus"></i></button></div></div>
                    <div><label for="artworkVerticalSpacing">Vertical Spacing:</label><div class="input-with-stepper"><button type="button" class="stepper-button" onclick="changeInputValue('artworkVerticalSpacing', -0.1, 'spacing')"><i class="fas fa-minus"></i></button><input type="number" id="artworkVerticalSpacing" step="0.1" value="0" onchange="calculateLayout();" /><button type="button" class="stepper-button" onclick="changeInputValue('artworkVerticalSpacing', 0.1, 'spacing')"><i class="fas fa-plus"></i></button></div></div>
                    <div><label for="spacingUnitSelect">Spacing Unit:</label><select id="spacingUnitSelect" onchange="toggleSpacingUnit()"><option value="mm">mm</option><option value="cm" selected>cm</option><option value="in">inch</option></select></div>
                    <div style="flex: none; width: auto; align-self: flex-end;"><button class="btn btn-control" onclick="resetSpacing()">Reset Spacing</button></div>
                </div>
                <span class="info-text general-info-text" id="spacingInfoUnitText">Spacing between artwork edges (in <span id="spacingInfoUnit">cm</span>).</span>
                <div class="row">
                    <div style="flex: 1;"><label for="stickerShape">Sticker Shape:</label><select id="stickerShape" onchange="calculateLayout()"><option value="square">Square / Rectangle</option><option value="round" selected>Round / Oval</option></select></div>
                    <div style="flex: 1;"><label for="layoutMode">Layout Mode:</label><select id="layoutMode" onchange="calculateLayout()"><option value="standard">Standard Grid</option><option value="optimized">Optimized (Interlocking)</option><option value="brickByColumn">Brick by Column</option></select></div>
                </div>
                <div class="canvas-summary-text" id="canvasSummaryText"></div>
                <canvas id="layoutCanvas" width="880" height="700"></canvas>
                <div class="invoice-copy-area"><label for="invoiceText">Ready to Copy for Invoicing:</label><textarea id="invoiceText" readonly rows="5"></textarea><button id="copyBtn" class="btn btn-secondary" onclick="copyStickerInvoiceText()">Copy Text</button></div>
            </div>
        </div>`;
      initStickerEditor();
    }

    function renderMaterialGrid(container, type, forShortcut = false) {
      const sourceArray = type === 'largeFormat' ? materials : signboardMaterials;
      // Added an ID to the material-grid div
      let gridHTML = `<div class='material-grid' id='material-grid-${type}'>`;
      sourceArray.forEach((mat, i) => {
        if (mat.agent === undefined) mat.agent = false;
        const displayPrice = mat.agent ? mat.agentPrice : mat.customerPrice;
        const isActive = (i === selectedMaterialIndex) ? ' active' : '';
        const agentActive = mat.agent ? ' agent-active' : '';
        const priceUnit = mat.fixed ? '' : ' / sq ft';
        gridHTML += `<div class='material-card${isActive}'><div class='material-info' onclick="showCalculator('${type}', ${i})"><strong>${mat.name}</strong><span>${currentCurrency.symbol} ${formatCurrency(displayPrice)}${priceUnit}</span></div><button class='agent-toggle${agentActive}' onclick="event.stopPropagation(); toggleAgentPrice('${type}', ${i})">${mat.agent ? 'Agent Price ON' : 'Switch to Agent Price'}</button></div>`;
      });
      gridHTML += "</div>";
      if (!forShortcut) {
        const title = type === 'largeFormat' ? 'Large Format' : 'Signboard';
        // Added the search input field below the title
        const searchBarHTML = `
            <div class="mt-4">
                <input type="text" id="materialSearch" onkeyup="filterMaterials('${type}')" placeholder="Search for materials..." class="w-full max-w-md p-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600">
            </div>`;
        container.innerHTML = `<h2>${title} - Select Material</h2>${searchBarHTML}${gridHTML}`;
      }
      return gridHTML;
    }

    function renderStandGrid(container) {
      // Added the search input field
      const searchBarHTML = `
        <div class="mt-4">
            <input type="text" id="standSearch" onkeyup="filterStands()" placeholder="Search for stands..." class="w-full max-w-md p-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600">
        </div>`;
      // Added an ID to the material-grid div
      let html = `<h2>Stands - Select Type</h2>${searchBarHTML}<div class='material-grid' id='stand-grid'>`;
      stands.forEach((s, i) => {
        if (s.agent === undefined) s.agent = false;
        const displayPrice = s.agent ? s.agentPrice : s.customerPrice;
        const isActive = (i === selectedMaterialIndex) ? ' active' : '';
        const agentActive = s.agent ? ' agent-active' : '';
        html += `<div class='material-card${isActive}'><div class='material-info' onclick="selectStand(${i})"><strong>${s.name}</strong><span>${currentCurrency.symbol} ${formatCurrency(displayPrice)}</span></div><button class='agent-toggle${agentActive}' onclick="event.stopPropagation(); toggleAgentPrice('stand', ${i})">${s.agent ? 'Agent Price ON' : 'Switch to Agent Price'}</button></div>`;
      });
      html += "</div>";
      if (selectedMaterialIndex !== null) {
        const stand = stands[selectedMaterialIndex];
        const subTotal = stand.agent ? stand.agentPrice : stand.customerPrice;
        let resultHTML = `<strong>Selected: ${stand.name}</strong><br>`;
        let finalTotal = subTotal;
        if (isTaxEnabled) {
          const taxAmount = subTotal * (globalTaxPercent / 100);
          finalTotal += taxAmount;
          resultHTML += `Total Not Include Tax: ${currentCurrency.symbol} ${formatCurrency(subTotal)}<br>`;
          resultHTML += `Tax (${globalTaxPercent}%): ${currentCurrency.symbol} ${formatCurrency(taxAmount)}<br><br>`;
        }
        resultHTML += `<strong>Total Price: ${currentCurrency.symbol} ${formatCurrency(finalTotal)}</strong>`;
        html += `<div class="result">${resultHTML}</div>`;
      }
      container.innerHTML = html;
    }

    function toggleAgentPrice(category, index) {
      // Save the current search query before doing anything else.
      if (category === 'stand') {
        const searchInput = document.getElementById('standSearch');
        if (searchInput) {
          lastSearchQueries.stand = searchInput.value;
        }
      } else { // This covers both 'largeFormat' and 'signboard'
        const searchInput = document.getElementById('materialSearch');
        if (searchInput) {
          lastSearchQueries[category] = searchInput.value;
        }
      }
      const categoryMap = {
        'largeFormat': {
          array: materials,
          render: () => renderMaterialGrid(document.getElementById('contentArea'), 'largeFormat')
        },
        'stand': {
          array: stands,
          render: renderStandGrid
        },
        'signboard': {
          array: signboardMaterials,
          render: () => renderMaterialGrid(document.getElementById('contentArea'), 'signboard')
        }
      };
      const cat = categoryMap[category];
      if (cat) {
        cat.array[index].agent = !cat.array[index].agent;
        cat.render(document.getElementById('contentArea'));
      }
    }

    function selectStand(index) {
      selectedMaterialIndex = index;
      renderStandGrid(document.getElementById('contentArea'));
    }

    function showCalculator(category, index) {
      // Save the current search term before redrawing
      const searchInput = document.getElementById('materialSearch');
      if (searchInput) {
        lastSearchQueries[category] = searchInput.value;
      }
      selectedMaterialIndex = index;
      currentCategory = category;
      const material = (category === "largeFormat") ? materials[index] : signboardMaterials[index];
      if (!material) return;
      pricePerSqFt = material.agent ? material.agentPrice : material.customerPrice;
      isStickerOrPolysilk = material.simple;
      const content = document.getElementById('contentArea');
      // Manually create the search bar HTML so it's always included.
      const searchBarHTML = `
        <div class="mt-4 relative w-full max-w-md">
            <input type="text" id="materialSearch" onkeyup="filterMaterials('${category}')" placeholder="Search for materials..." class="w-full p-2 pr-10 border border-gray-300 rounded-md dark:bg-gray-800 dark:text-white dark:border-gray-600" value="${lastSearchQueries[category] || ''}">
            <button onclick="clearSearch('${category}')" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <i class="fas fa-times-circle"></i>
            </button>
        </div>`;
      const gridHTML = (category === "largeFormat") ? renderMaterialGrid(content, 'largeFormat', true) : renderMaterialGrid(content, 'signboard', true);
      const catName = (category === "largeFormat") ? "Large Format" : "Signboard";
      const defaultWidth = material.fixed ? material.fixedWidth : 3;
      const defaultHeight = material.fixed ? material.fixedHeight : 2;
      const isFixed = material.fixed;
      content.innerHTML = `<h2>${catName} - Select Material</h2>${searchBarHTML}${gridHTML}<h2 style="margin-top: 24px;">Material: ${material.name} (${currentCurrency.symbol} ${formatCurrency(pricePerSqFt)} / sq ft)</h2><div class='calculator-panel'>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: flex-end;">
        <div><label for='width'>Width:</label><input type='number' id='width' step='0.1' value='${defaultWidth}' oninput='lastClickedASize = null; clearASizeHighlight(); kiraHarga();' ${isFixed ? 'disabled' : ''}/></div>
        <div><label for='height'>Height:</label><input type='number' id='height' step='0.1' value='${defaultHeight}' oninput='lastClickedASize = null; clearASizeHighlight(); kiraHarga();' ${isFixed ? 'disabled' : ''}/></div>
        <button class="btn btn-secondary" onclick="switchDimensions()" style="padding: 10px; margin-bottom: 4px;" ${isFixed ? 'disabled' : ''}><i class="fas fa-exchange-alt"></i></button>
    </div>

    <div class="options-grid" style="grid-template-columns: 1fr 2fr; align-items: end; gap: 20px; margin-top: 1rem;"><div><label for='measurementUnit'>Unit:</label><select id='measurementUnit' onchange='changeUnits(this.value)' ${isFixed ? 'disabled' : ''}><option value='ft' selected>Feet (ft)</option><option value='in'>Inches (in)</option><option value='cm'>Centimeter (cm)</option><option value='mm'>Millimeter (mm)</option><option value='m'>Meter (m)</option></select></div><div><label>Preset A-Sizes:</label><div id="aSizeBtnGroup" class="size-btn-group" style="flex-wrap: wrap;"><button id="btn-A0" class="size-btn" onclick="setASize('A0', 841, 1189)">A0</button><button id="btn-A1" class="size-btn" onclick="setASize('A1', 594, 841)">A1</button><button id="btn-A2" class="size-btn" onclick="setASize('A2', 420, 594)">A2</button><button id="btn-A3" class="size-btn" onclick="setASize('A3', 297, 420)">A3</button><button id="btn-A4" class="size-btn" onclick="setASize('A4', 210, 297)">A4</button><button id="btn-A5" class="size-btn" onclick="setASize('A5', 148, 210)">A5</button><button id="btn-A6" class="size-btn" onclick="setASize('A6', 105, 148)">A6</button></div></div></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 1rem;">${!material.simple ? `<div><label for='eyeletOption'>Finishing:</label><select id='eyeletOption' onchange='toggleEyeletInput()'><option value='auto' selected>Auto Eyelets</option><option value='manual'>Manual Eyelets</option><option value='none'>No Finishing</option><option value='pipe'>Pipe</option></select></div>` : ""}<div><label for='whiteBorderOption'>White Border:</label><select id='whiteBorderOption' onchange='kiraHarga()'><option value='none'>None</option><option value='2'>2 inches</option><option value='3'>3 inches</option><option value='4'>4 inches</option><option value='5'>5 inches</option></select></div></div><div id='manualEyeletFields' style='display:none; margin-top: 10px; grid-template-columns: repeat(4, 1fr); gap: 10px;'><div><label>Top</label><input type='number' id='manualTop' value='0' oninput='kiraHarga()'/></div><div><label>Bottom</label><input type='number' id='manualBottom' value='0' oninput='kiraHarga()'/></div><div><label>Left</label><input type='number' id='manualLeft' value='0' oninput='kiraHarga()'/></div><div><label>Right</label><input type='number' id='manualRight' value='0' oninput='kiraHarga()'/></div></div><div class="modern-checkbox-grid" style="grid-template-columns: 1fr; margin-top: 16px;"><div class="checkbox-group"><input type='checkbox' id='governmentChk' onchange="kiraHarga()"/><label for='governmentChk'>Add Government ${globalGovSurchargePercent}%</label></div></div><div class='result' id='result'></div><canvas id='previewCanvas' width='760' height='400'></canvas><div class="invoice-copy-area"><label for="invoiceText">Invoice Text:</label><textarea id="invoiceText" readonly rows="5"></textarea><button id="copyBtn" class="btn btn-secondary" onclick="copyInvoiceText()">Copy</button></div></div>`;
      kiraHarga();
      if (document.getElementById('eyeletOption')) {
        toggleEyeletInput();
      }
      // Re-apply the filter after rendering
      if (lastSearchQueries[category]) {
        filterMaterials(category);
      }
    }

    function setASize(sizeName, w_mm, h_mm) {
      lastClickedASize = sizeName;
      // --- ADD THIS BLOCK FOR VISUAL HIGHLIGHTING ---
      clearASizeHighlight();
      const button = document.getElementById(`btn-${sizeName}`);
      if (button) {
        button.classList.add('active');
      }
      // ---------------------------------------------
      const targetUnit = document.getElementById('measurementUnit').value;
      const convertedWidth = convertFromMm(w_mm, targetUnit);
      const convertedHeight = convertFromMm(h_mm, targetUnit);
      const precision = (targetUnit === 'mm') ? 0 : 2;
      document.getElementById('width').value = convertedWidth.toFixed(precision);
      document.getElementById('height').value = convertedHeight.toFixed(precision);
      kiraHarga();
    }

    function changeUnits(newUnit) {
      if (newUnit === currentInputUnit) return;
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const currentWidth = parseFloat(widthInput.value) || 0;
      const currentHeight = parseFloat(heightInput.value) || 0;
      // Convert current values to a base unit (mm)
      const widthInMm = convertToMm(currentWidth, currentInputUnit);
      const heightInMm = convertToMm(currentHeight, currentInputUnit);
      // Convert from base unit (mm) to the new unit
      const newConvertedWidth = convertFromMm(widthInMm, newUnit);
      const newConvertedHeight = convertFromMm(heightInMm, newUnit);
      const precision = (newUnit === 'mm' || newUnit === 'cm') ? 1 : 2;
      widthInput.value = newConvertedWidth.toFixed(precision);
      heightInput.value = newConvertedHeight.toFixed(precision);
      // Update the global state for the next conversion
      currentInputUnit = newUnit;
      // Recalculate and redraw the canvas with the new unit
      kiraHarga();
    }

    function switchDimensions() {
      const widthInput = document.getElementById('width');
      const heightInput = document.getElementById('height');
      const tempWidth = widthInput.value;
      widthInput.value = heightInput.value;
      heightInput.value = tempWidth;
      // Recalculate the price with the new dimensions
      kiraHarga();
    }

    function kiraHarga() {
      const widthEl = document.getElementById("width");
      if (!widthEl) return;
      const widthRaw = parseFloat(widthEl.value);
      const heightRaw = parseFloat(document.getElementById("height").value);
      const unit = document.getElementById("measurementUnit").value;
      const w = convertToFeetCalc(widthRaw, unit);
      const h = convertToFeetCalc(heightRaw, unit);
      const resultDiv = document.getElementById("result");
      const invoiceTextArea = document.getElementById("invoiceText");
      if (isNaN(w) || isNaN(h) || w <= 0 || h <= 0) {
        resultDiv.innerText = "Invalid dimensions.";
        if (invoiceTextArea) invoiceTextArea.value = "";
        return;
      }
      const optEl = document.getElementById("eyeletOption");
      const opt = optEl ? optEl.value : 'none';
      const government = document.getElementById("governmentChk").checked;
      const whiteBorder = document.getElementById("whiteBorderOption").value;
      let totalW = w,
        totalH = h;
      let details = `Size (ft): ${w.toFixed(2)} x ${h.toFixed(2)}<br>Area: ${(w * h).toFixed(2)} sq ft<br>`;
      if (whiteBorder !== 'none' && opt !== 'pipe') {
        const borderInches = parseInt(whiteBorder);
        totalW += 2 * (borderInches / 12);
        totalH += 2 * (borderInches / 12);
        details += `With ${borderInches}" Border: ${totalW.toFixed(2)}ft x ${totalH.toFixed(2)}ft<br>`;
      }
      let area = totalW * totalH;
      let basePrice = area * pricePerSqFt;
      let subTotal = basePrice;
      details += `Base Price: ${currentCurrency.symbol} ${formatCurrency(basePrice)}<br>`;
      let eyelet = 0,
        eyeletCost = 0,
        glueCost = 0,
        gam = 0;
      if (opt === "pipe") {
        let pipeCost = w * globalPipePrice;
        subTotal += pipeCost;
        details += `Pipe Cost: ${w.toFixed(2)} ft (${currentCurrency.symbol} ${formatCurrency(pipeCost)})<br>`;
      } else if (opt !== 'none' && !isStickerOrPolysilk) {
        if (opt === "manual") {
          eyelet = (parseInt(document.getElementById("manualTop").value) || 0) + (parseInt(document.getElementById("manualBottom").value) || 0) + (parseInt(document.getElementById("manualLeft").value) || 0) + (parseInt(document.getElementById("manualRight").value) || 0);
        } else if (opt === "auto") {
          eyelet = autoEyelet(w, h);
        }
        if (!isExceptionSize(w, h) && !isGamExemptedSize(w, h)) {
          gam = Math.round(w + h);
        }
        eyeletCost = eyelet * globalEyeletPrice;
        glueCost = gam * globalGluePrice;
        subTotal += eyeletCost + glueCost;
        if (eyelet > 0) details += `Eyelets: ${eyelet} pcs (${currentCurrency.symbol} ${formatCurrency(eyeletCost)})<br>`;
        if (gam > 0) details += `Glue: ${gam} ft (${currentCurrency.symbol} ${formatCurrency(glueCost)})<br>`;
      }
      if (government) {
        const govSurcharge = basePrice * (globalGovSurchargePercent / 100);
        subTotal += govSurcharge;
        details += `Govt Surcharge (${globalGovSurchargePercent}%): ${currentCurrency.symbol} ${formatCurrency(govSurcharge)}<br>`;
      }
      let finalTotal = subTotal;
      if (isTaxEnabled) {
        const taxAmount = subTotal * (globalTaxPercent / 100);
        finalTotal += taxAmount;
        details += `Total Not Include Tax: ${currentCurrency.symbol} ${formatCurrency(subTotal)}<br>`;
        details += `Tax (${globalTaxPercent}%): ${currentCurrency.symbol} ${formatCurrency(taxAmount)}<br>`;
      }
      details += `<br><strong>Total Price: ${currentCurrency.symbol} ${formatCurrency(finalTotal)}</strong>`;
      resultDiv.innerHTML = details;
      updatePreview();
      if (invoiceTextArea) {
        const presetLabel = lastClickedASize ? `(${lastClickedASize}) ` : "";
        // --- THIS IS THE ONLY LINE THAT CHANGED ---
        let invoiceText = `Print\nSize : ${presetLabel}${parseFloat(widthRaw.toFixed(2))}${unit} (W) x ${parseFloat(heightRaw.toFixed(2))}${unit} (H)\nMaterial : ${currentCategory === 'largeFormat' ? materials[selectedMaterialIndex].name : signboardMaterials[selectedMaterialIndex].name}\n`;
        if (whiteBorder !== 'none') invoiceText += `White Border : ${whiteBorder}in\n`;
        if (!isStickerOrPolysilk) {
          switch (opt) {
            case 'auto':
            case 'manual':
              invoiceText += `Eyelet : ${eyelet}pcs\n`;
              break;
            case 'pipe':
              invoiceText += `Pipe : Top & Bottom\n`;
              break;
          }
        }
        invoiceText += `Price : ${currentCurrency.symbol}${formatCurrency(finalTotal)}`;
        invoiceTextArea.value = invoiceText;
      }
    }

    function toggleEyeletInput() {
      document.getElementById("manualEyeletFields").style.display = (document.getElementById("eyeletOption").value === "manual") ? "grid" : "none";
      kiraHarga();
    }

    function updatePreview() {
      const widthInput = document.getElementById("width"),
        heightInput = document.getElementById("height");
      if (!widthInput || !heightInput) return;
      const rawW = parseFloat(widthInput.value) || 0,
        rawH = parseFloat(heightInput.value) || 0,
        unit = document.getElementById("measurementUnit").value,
        wFt = convertToFeetCalc(rawW, unit),
        hFt = convertToFeetCalc(rawH, unit);
      if (isNaN(wFt) || isNaN(hFt) || wFt <= 0 || hFt <= 0) return;
      const eyeletOption = document.getElementById("eyeletOption"),
        mode = eyeletOption ? eyeletOption.value : "auto";
      let manualCounts = {};
      if (mode === "manual") {
        manualCounts = {
          top: parseInt(document.getElementById("manualTop").value) || 0,
          bottom: parseInt(document.getElementById("manualBottom").value) || 0,
          left: parseInt(document.getElementById("manualLeft").value) || 0,
          right: parseInt(document.getElementById("manualRight").value) || 0
        };
      }
      drawPreview(rawW, rawH, unit, wFt, hFt, isExceptionSize(wFt, hFt), isStickerOrPolysilk, mode, manualCounts);
    }

    function drawPreview(rawW, rawH, unit, w, h, isEx, isSimple, mode = "auto", manual = {}) {
      const canvas = document.getElementById("previewCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const pad = 70,
        availWidth = canvas.width - pad * 2,
        availHeight = canvas.height - pad * 2;
      const whiteBorderEl = document.getElementById("whiteBorderOption");
      let whiteBorderInches = (whiteBorderEl && whiteBorderEl.value !== 'none') ? parseInt(whiteBorderEl.value) : 0;
      let outerW = w,
        outerH = h;
      if (whiteBorderInches > 0) {
        const whiteBorderFeet = whiteBorderInches / 12;
        outerW += 2 * whiteBorderFeet;
        outerH += 2 * whiteBorderFeet;
      }
      const scale = Math.min(availWidth / outerW, availHeight / outerH);
      const outerDw = outerW * scale,
        outerDh = outerH * scale,
        outerSx = (canvas.width - outerDw) / 2,
        outerSy = (canvas.height - outerDh) / 2;
      if (whiteBorderInches > 0) {
        ctx.fillStyle = "#E9ECEF";
        ctx.fillRect(outerSx, outerSy, outerDw, outerDh);
      }
      const dw = w * scale,
        dh = h * scale,
        sx = (canvas.width - dw) / 2,
        sy = (canvas.height - dh) / 2;
      const grad = ctx.createLinearGradient(sx, sy, sx + dw, sy + dh);
      grad.addColorStop(0, "#007BFF");
      grad.addColorStop(1, "#17a2b8");
      ctx.fillStyle = grad;
      ctx.fillRect(sx, sy, dw, dh);
      drawDimensionLines(ctx, sx, sy, dw, dh, rawW, rawH, unit);
      if (isSimple || mode === 'none' || mode === 'pipe') return;
      const drawEyelet = (x, y) => {
        ctx.beginPath();
        ctx.arc(x, y, 3.5, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.strokeStyle = "#343a40";
        ctx.lineWidth = 1;
        ctx.fill();
        ctx.stroke();
      };
      const offset = 12;
      if (mode === "manual") {
        const {
          top,
          bottom,
          left,
          right
        } = manual;
        // Top - New corners-first logic
        if (top === 1) {
          drawEyelet(sx + dw / 2, sy + offset);
        } else if (top >= 2) {
          drawEyelet(sx + offset, sy + offset);
          drawEyelet(sx + dw - offset, sy + offset);
          const remaining = top - 2;
          const innerWidth = dw - 2 * offset;
          for (let i = 1; i <= remaining; i++) {
            drawEyelet(sx + offset + (innerWidth / (remaining + 1)) * i, sy + offset);
          }
        }
        // Bottom - New corners-first logic
        if (bottom === 1) {
          drawEyelet(sx + dw / 2, sy + dh - offset);
        } else if (bottom >= 2) {
          drawEyelet(sx + offset, sy + dh - offset);
          drawEyelet(sx + dw - offset, sy + dh - offset);
          const remaining = bottom - 2;
          const innerWidth = dw - 2 * offset;
          for (let i = 1; i <= remaining; i++) {
            drawEyelet(sx + offset + (innerWidth / (remaining + 1)) * i, sy + dh - offset);
          }
        }
        // Left
        if (left > 0) {
          for (let i = 1; i <= left; i++) {
            drawEyelet(sx + offset, sy + (dh / (left + 1)) * i);
          }
        }
        // Right
        if (right > 0) {
          for (let i = 1; i <= right; i++) {
            drawEyelet(sx + dw - offset, sy + (dh / (right + 1)) * i);
          }
        }
      } else if (mode === "auto") {
        // Draw 4 corners for auto mode
        drawEyelet(sx + offset, sy + offset);
        drawEyelet(sx + dw - offset, sy + offset);
        drawEyelet(sx + offset, sy + dh - offset);
        drawEyelet(sx + dw - offset, sy + dh - offset);
        if (!isEx) { // Only add extra eyelets if not an exception size
          let topCount = Math.round(w / 2) - 1;
          for (let i = 1; i <= topCount; i++) drawEyelet(sx + (dw / (topCount + 1)) * i, sy + offset);
          let bottomCount = Math.round(w / 3) - 1;
          for (let i = 1; i <= bottomCount; i++) drawEyelet(sx + (dw / (bottomCount + 1)) * i, sy + dh - offset);
          let sideEach = (h > 2.5 && h <= 3) ? 1 : (h > 3 && h <= 4) ? 2 : (h > 4) ? 2 : 0;
          for (let i = 1; i <= sideEach; i++) {
            let y = sy + (dh / (sideEach + 1)) * i;
            drawEyelet(sx + offset, y);
            drawEyelet(sx + dw - offset, y);
          }
        }
      }
    }

    function drawDimensionLines(ctx, sx, sy, dw, dh, rawW, rawH, unit) {
      const offset = 45;
      const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim() || '#dc3545';
      // --- CHANGE IS HERE ---
      // The canvas background is always white, so the text should always be dark.
      const textColor = '#212529'; // Reverted to original black color for all modes
      // --- END OF CHANGE ---
      ctx.strokeStyle = dangerColor;
      ctx.lineWidth = 1.5;
      const lineY = sy - offset + 10;
      ctx.beginPath();
      ctx.moveTo(sx, lineY);
      ctx.lineTo(sx + dw, lineY);
      ctx.stroke();
      const lineX = sx - offset;
      ctx.beginPath();
      ctx.moveTo(lineX, sy);
      ctx.lineTo(lineX, sy + dh);
      ctx.stroke();
      ctx.fillStyle = textColor; // Text color is set here
      ctx.font = "bold 13px Poppins";
      ctx.textAlign = "center";
      ctx.textBaseline = 'bottom';
      ctx.fillText(`${rawW.toFixed(2)} ${unit}`, sx + dw / 2, lineY - 5);
      ctx.save();
      ctx.translate(lineX - 10, sy + dh / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.textBaseline = 'bottom';
      ctx.fillText(`${rawH.toFixed(2)} ${unit}`, 0, 0);
      ctx.restore();
      // --- MODIFIED BLOCK ---
      // If an A-Size preset was clicked, draw its name below the canvas
      if (lastClickedASize) {
        const bottomLineY = sy + dh + offset - 10; // Same offset from bottom edge
        ctx.textAlign = "center";
        ctx.textBaseline = 'top'; // Align text to the top of the line
        // Set a new, larger font size for the preset label
        ctx.font = "bold 16px Poppins"; // Changed to 16px, adjust as needed
        ctx.fillText(lastClickedASize, sx + dw / 2, bottomLineY + 5); // Add 5 for padding
        // Reset the font back to the original size for the next draw cycle
        ctx.font = "bold 13px Poppins";
      }
      // --- END OF MODIFIED BLOCK ---
    }

    function clearASizeHighlight() {
      const group = document.getElementById('aSizeBtnGroup');
      if (group) {
        group.querySelectorAll('.size-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
    }

    function setASize(sizeName, w_mm, h_mm) {
      lastClickedASize = sizeName; // Store the preset name
      // --- Add this block for visual highlighting ---
      clearASizeHighlight();
      const button = document.getElementById(`btn-${sizeName}`);
      if (button) {
        button.classList.add('active');
      }
      // ---------------------------------------------
      const targetUnit = document.getElementById('measurementUnit').value;
      const convertedWidth = convertFromMm(w_mm, targetUnit);
      const convertedHeight = convertFromMm(h_mm, targetUnit);
      const precision = (targetUnit === 'mm') ? 0 : 2;
      document.getElementById('width').value = convertedWidth.toFixed(precision);
      document.getElementById('height').value = convertedHeight.toFixed(precision);
      kiraHarga();
    }

    function renderBusinessCardPage(container) {
      const {
        quantities,
        materials,
        addons,
        printSides
      } = businessCardData;
      const qtyButtons = quantities.map(q => `<button class="btn size-btn ${q.value === selectedBc.qty ? 'active' : ''}" data-value="${q.value}">${q.label}</button>`).join('');
      const materialCheckboxes = materials.map((m, i) => `<div class="checkbox-group"><input type="checkbox" name="bcMaterial" value="${i}" id="mat${i}" ${i === selectedBc.material ? 'checked' : ''}><label for="mat${i}">${m.name}</label></div>`).join('');
      const sideButtons = printSides.map(s => `<button class="btn size-btn ${s.value === selectedBc.printSide ? 'active' : ''}" data-value="${s.value}">${s.label}</button>`).join('');
      let addonHTML = '<div class="options-grid">';
      addons.forEach((addon, addonIndex) => {
        const addonButtons = addon.options.map((opt, optIndex) =>
          `<button class="btn size-btn ${optIndex === selectedBc.selectedAddons[addonIndex] ? 'active' : ''}" data-addon-index="${addonIndex}" data-option-index="${optIndex}">${opt.name || opt.label}</button>`
        ).join('');
        addonHTML += `<div class="option-box"><label>${addon.name}</label><div class="size-btn-group" id="bcAddonGroup${addonIndex}">${addonButtons}</div></div>`;
      });
      addonHTML += '</div>';
      container.innerHTML = `<div class="calculator-container"><h2>Business Card</h2><div class="options-grid" style="grid-template-columns: 1fr 1fr;"><div class="option-box"><label>Quantity</label><div class="size-btn-group" id="bcQtyGroup">${qtyButtons}</div></div><div class="option-box"><label>Print Side</label><div class="size-btn-group" id="bcSideGroup">${sideButtons}</div></div></div>${addonHTML}<div class="option-box" style="margin-top: 20px;"><label>Material</label><div class="modern-checkbox-grid" id="bcMaterialGroup">${materialCheckboxes}</div></div><div id="bcInvoice" class="invoice"></div></div>`;
      const updateInvoice = () => {
        const qty = selectedBc.qty;
        const mat = businessCardData.materials[selectedBc.material];
        const side = selectedBc.printSide;
        const matPrice = side === 1 ? mat.p1[qty] : mat.p2[qty];
        // --- LOGIC CHANGE IS HERE ---
        let addonPrice = 0;
        let invoiceDetailsHTML = '';
        // 1. Add Material row
        invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Material</span><span class="invoice-value">${mat.name}</span></div>`;
        // 2. Add Print Side row
        invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Print Side</span><span class="invoice-value">${side} Side</span></div>`;
        // 3. Add Laminate (Finishing) row, if selected
        const laminateIndex = 0; // Finishing is the first addon
        const laminateOption = addons[laminateIndex].options[selectedBc.selectedAddons[laminateIndex]];
        addonPrice += laminateOption.price;
        if (selectedBc.selectedAddons[laminateIndex] > 0) {
          invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Laminate</span><span class="invoice-value">${laminateOption.name}</span></div>`;
        }
        // 4. Add Round Corner row, if selected
        const roundCornerIndex = 1; // Round Corner is the second addon
        const roundCornerOption = addons[roundCornerIndex].options[selectedBc.selectedAddons[roundCornerIndex]];
        addonPrice += roundCornerOption.price;
        if (selectedBc.selectedAddons[roundCornerIndex] > 0) {
          invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Round Corner</span><span class="invoice-value">${roundCornerOption.name}</span></div>`;
        }
        // 5. Add Spot UV row, if selected
        const spotUvIndex = 2; // Spot UV is the third addon
        const spotUvOption = addons[spotUvIndex].options[selectedBc.selectedAddons[spotUvIndex]];
        addonPrice += spotUvOption.price;
        if (selectedBc.selectedAddons[spotUvIndex] > 0) {
          invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Spot UV</span><span class="invoice-value">${spotUvOption.name}</span></div>`;
        }
        const unitPrice = matPrice + addonPrice;
        // 6. Add Price Per Box row
        invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Price Per Box</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(unitPrice)}</span></div>`;
        // 7. Add Quantity row
        invoiceDetailsHTML += `<div class="invoice-row"><span class="invoice-label">Quantity</span><span class="invoice-value">${qty} Box${qty > 1 ? 'es' : ''}</span></div>`;
        // Calculate totals and add tax row if needed
        const subTotal = qty * unitPrice;
        let taxRow = '';
        let finalTotal = subTotal;
        if (isTaxEnabled) {
          const taxAmount = subTotal * (globalTaxPercent / 100);
          finalTotal += taxAmount;
          taxRow = `<div class="invoice-row"><span class="invoice-label">Tax (${globalTaxPercent}%)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(taxAmount)}</span></div>`;
        }
        // Assemble the final invoice
        document.getElementById('bcInvoice').innerHTML = `<div class="invoice-body">${invoiceDetailsHTML}${taxRow}</div><div class="invoice-nett"><span>Nett Price</span><span>${currentCurrency.symbol} ${formatCurrency(finalTotal)}</span></div><a href="https://www.google.com/" target="_blank" class="btn-link">Download Template</a>`;
      };
      // --- END OF LOGIC CHANGE ---
      document.getElementById('bcQtyGroup').addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;
        document.getElementById('bcQtyGroup').querySelectorAll('button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        selectedBc.qty = parseInt(e.target.dataset.value);
        updateInvoice();
      });
      document.getElementById('bcSideGroup').addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;
        document.getElementById('bcSideGroup').querySelectorAll('button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        selectedBc.printSide = parseInt(e.target.dataset.value);
        updateInvoice();
      });
      businessCardData.addons.forEach((_, addonIndex) => {
        document.getElementById(`bcAddonGroup${addonIndex}`).addEventListener('click', e => {
          if (e.target.tagName !== 'BUTTON') return;
          document.getElementById(`bcAddonGroup${addonIndex}`).querySelectorAll('button').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          selectedBc.selectedAddons[addonIndex] = parseInt(e.target.dataset.optionIndex);
          updateInvoice();
        });
      });
      const materialGroup = document.getElementById('bcMaterialGroup');
      materialGroup.addEventListener('change', e => {
        if (e.target.name === 'bcMaterial') {
          materialGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            if (cb !== e.target) cb.checked = false;
          });
          e.target.checked = true;
          selectedBc.material = parseInt(e.target.value);
          updateInvoice();
        }
      });
      updateInvoice();
    }

    function getSublimationBasePrice(qty) {
      if (qty >= 500) return 30.00;
      if (qty >= 100) return 37.00;
      if (qty >= 50) return 40.00;
      if (qty >= 30) return 43.00;
      return 45.00;
    }

    function renderSublimationCalculator(container) {
      const quantities = [{
        label: "1-29",
        value: 10
      }, {
        label: "30-49",
        value: 30
      }, {
        label: "50-99",
        value: 50
      }, {
        label: "100-499",
        value: 100
      }, {
        label: "500+",
        value: 500
      }];
      let qtyButtonsHTML = quantities.map(q => `<button class="btn size-btn ${q.value === selectedSublimationQty ? 'active' : ''}" data-qty="${q.value}">${q.label}</button>`).join('');
      const sizes = [{
        label: "XS-2XL",
        value: "L"
      }, {
        label: "3XL",
        value: "3XL"
      }, {
        label: "4XL",
        value: "4XL"
      }, {
        label: "5XL",
        value: "5XL"
      }, {
        label: "6XL",
        value: "6XL"
      }, {
        label: "7XL",
        value: "7XL"
      }, {
        label: "8XL",
        value: "8XL"
      }];
      let sizeButtonsHTML = sizes.map(sz => `<button class="btn size-btn ${sz.value === 'L' ? 'active' : ''}" data-size="${sz.value}">${sz.label}</button>`).join('');
      let variationHTML = sublimationVariations.map((v, i) => `<div class='checkbox-group'><input type='checkbox' id='var${i}' value='${v.cost}' onchange="kiraSublimation()"><label for='var${i}'><span>${v.label}</span><span style="margin-left: auto; font-weight: 600; color: var(--primary-color);">+${currentCurrency.symbol}${formatCurrency(v.cost)}</span></label></div>`).join('');
      container.innerHTML = `<div class="calculator-container"><h2>Sublimation Apparel</h2><div class="options-grid" style="grid-template-columns: 1fr; gap: 20px;"><div class="option-box"><label>Quantity</label><div class="size-btn-group" id="sublimationQtyBtns">${qtyButtonsHTML}</div></div><div class="option-box"><label>Apparel Size</label><div class="size-btn-group" id="sublimationSizeBtns">${sizeButtonsHTML}</div></div></div><div class="option-box" style="margin-top: 20px;"><label>Variations & Add-ons</label><div class="modern-checkbox-grid" style="margin-top: 12px;">${variationHTML}</div></div><div id="sublimationInvoice" class="invoice"></div></div>`;
      document.querySelectorAll('#sublimationQtyBtns .size-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('#sublimationQtyBtns .size-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          selectedSublimationQty = parseInt(button.dataset.qty);
          kiraSublimation();
        });
      });
      document.querySelectorAll('#sublimationSizeBtns .size-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('#sublimationSizeBtns .size-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          kiraSublimation();
        });
      });
      kiraSublimation();
    }

    function kiraSublimation() {
      const qty = selectedSublimationQty;
      const invoiceEl = document.getElementById("sublimationInvoice");
      if (!invoiceEl) return;
      const activeSizeButton = document.querySelector("#sublimationSizeBtns .size-btn.active");
      const size = activeSizeButton ? activeSizeButton.dataset.size : "L";
      const sizeLabel = activeSizeButton ? activeSizeButton.innerText : "XS-2XL";
      const activeQtyButton = document.querySelector("#sublimationQtyBtns .size-btn.active");
      const qtyLabel = activeQtyButton ? activeQtyButton.innerText : qty;
      const basePrice = getSublimationBasePrice(qty);
      const sizeCost = extraSizeCost[size] || 0.00;
      let totalVariationCost = 0;
      let variationDetails = [];
      sublimationVariations.forEach((v, i) => {
        const checkbox = document.getElementById(`var${i}`);
        if (checkbox && checkbox.checked) {
          totalVariationCost += v.cost;
          variationDetails.push(`<div class="invoice-row"><span class="invoice-label">${v.label}</span><span class="invoice-value">+ ${currentCurrency.symbol} ${formatCurrency(v.cost)}</span></div>`);
        }
      });
      const subTotalPerPiece = basePrice + sizeCost + totalVariationCost;
      let finalTotalPerPiece = subTotalPerPiece;
      let invoiceBodyHTML = '';
      const baseRows = `
    <div class="invoice-row"><span class="invoice-label">Base Price (Tier: ${qtyLabel} pcs)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(basePrice)} / pc</span></div>
    <div class="invoice-row"><span class="invoice-label">Extra Size Cost (${sizeLabel})</span><span class="invoice-value">+ ${currentCurrency.symbol} ${formatCurrency(sizeCost)}</span></div>
    ${variationDetails.join('')}
  `;
      if (isTaxEnabled) {
        const taxAmountPerPiece = subTotalPerPiece * (globalTaxPercent / 100);
        finalTotalPerPiece += taxAmountPerPiece;
        invoiceBodyHTML = `
      ${baseRows}
      <div class="invoice-row" style="font-weight: bold;"><span class="invoice-label">Final Price Per Piece (Without Tax)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(subTotalPerPiece)}</span></div>
      <div class="invoice-row"><span class="invoice-label">Tax (${globalTaxPercent}%)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(taxAmountPerPiece)}</span></div>
    `;
      } else {
        invoiceBodyHTML = baseRows;
      }
      invoiceEl.innerHTML = `
    <div class="invoice-body">${invoiceBodyHTML}</div>
    <div class="invoice-nett">
        <span>Total For 1 Piece</span>
        <span>${currentCurrency.symbol} ${formatCurrency(finalTotalPerPiece)}</span>
    </div>
    <a href="https://www.google.com/" target="_blank" class="btn-link">Download Template</a>`;
    }

    function getIDCUnitPrice(qty) {
      for (let i = idCardRates.length - 1; i >= 0; i--) {
        if (qty >= idCardRates[i].qty) return idCardRates[i].unitPrice;
      }
      return idCardRates[0] ? idCardRates[0].unitPrice : 25.0;
    }

    function kiraIdCard() {
      const qty = selectedIdCardQty;
      const invoiceEl = document.getElementById("idCardInvoice");
      const sideOptionEl = document.getElementById("idCardSide");
      if (!invoiceEl || !sideOptionEl) return;
      const sideOption = sideOptionEl.value;
      const baseUnitPrice = getIDCUnitPrice(qty);
      const sideSurcharge = sideOption === '2' ? 2.00 : 0.00;
      const finalUnitPrice = baseUnitPrice + sideSurcharge;
      const subTotal = finalUnitPrice * qty;
      let taxRow = '';
      let finalTotal = subTotal;
      if (isTaxEnabled) {
        const taxAmount = subTotal * (globalTaxPercent / 100);
        finalTotal += taxAmount;
        taxRow = `<div class="invoice-row"><span class="invoice-label">Tax (${globalTaxPercent}%) For order (${qty} Cards)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(taxAmount)}</span></div>`;
      }
      invoiceEl.innerHTML = `<div class="invoice-body"><div class="invoice-row"><span class="invoice-label">Tiered Price (${qty} pcs)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(baseUnitPrice)}/pc</span></div><div class="invoice-row"><span class="invoice-label">Print Side</span><span class="invoice-value">${sideOption === '2' ? `Double Sided (+${currentCurrency.symbol} ${formatCurrency(2.00)})` : 'Single Sided'}</span></div><div class="invoice-row final"><span class="invoice-label">Final Price/Card</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(finalUnitPrice)}</span></div>${taxRow}</div><div class="invoice-nett"><span>Total for ${qty} Card${qty > 1 ? 's' : ''}</span><span>${currentCurrency.symbol} ${formatCurrency(finalTotal)}</span></div><a href="https://www.google.com/" target="_blank" class="btn-link">Download Template</a>`;
    }

    function renderIDCardCalculator(container) {
      let qtyButtonsHTML = idCardRates.map(rate => `<button class="btn size-btn ${rate.qty === selectedIdCardQty ? 'active' : ''}" data-qty="${rate.qty}">${rate.qty} pcs</button>`).join('');
      container.innerHTML = `<div class="calculator-container"><h2>ID Card</h2><div class="options-grid" style="grid-template-columns: 1fr; gap: 20px;"><div class="option-box"><label>Quantity</label><div class="size-btn-group" id="idCardQtyBtns">${qtyButtonsHTML}</div></div><div class="option-box"><label for="idCardSide">Print Side</label><select id="idCardSide" onchange="kiraIdCard()"><option value="1">Single Sided</option><option value="2">Double Sided (+RM 2.00)</option></select></div></div><div id="idCardInvoice" class="invoice"></div></div>`;
      document.querySelectorAll('#idCardQtyBtns .size-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('#idCardQtyBtns .size-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          selectedIdCardQty = parseInt(button.dataset.qty);
          kiraIdCard();
        });
      });
      kiraIdCard();
    }

    function kiraInvitationCard() {
      const sizeEl = document.querySelector("#invCardSizeBtns .active"),
        sideEl = document.querySelector("#invCardSideBtns .active"),
        qtyEl = document.getElementById('invCardQty'),
        invoiceEl = document.getElementById('invCardInvoice');
      if (!sizeEl || !qtyEl || !sideEl || !invoiceEl) return;
      const size = sizeEl.dataset.size,
        qty = +qtyEl.value,
        side = +sideEl.dataset.side,
        material = invitationCardData.materials[selectedInvCardMaterial];
      const baseUnit = (((invitationCardData.basePrice[size] || {})[qty] || {})[side]) || 0;
      const matAdd = ((invitationCardData.materialAddOn[size] || {})[material]) || 0;
      let totalAddonsCost = 0;
      let addonsDetailsHTML = '';
      invitationCardData.addons.forEach((addon, addonIndex) => {
        const selectedOptionIndex = selectedInvCardAddons[addonIndex] || 0;
        const selectedOption = addon.options[selectedOptionIndex];
        const addonPrice = selectedOption.prices[size] || 0;
        totalAddonsCost += addonPrice;
        addonsDetailsHTML += `<div class="invoice-row"><span class="invoice-label">${addon.name}</span><span class="invoice-value">${selectedOption.name}</span></div>`;
      });
      const unitPrice = baseUnit + matAdd + totalAddonsCost;
      const subTotal = unitPrice * qty;
      let taxRow = '';
      let finalTotal = subTotal;
      if (isTaxEnabled) {
        const taxAmount = subTotal * (globalTaxPercent / 100);
        finalTotal += taxAmount;
        taxRow = `<div class="invoice-row"><span class="invoice-label">Tax (${globalTaxPercent}%) For order (${qty}pcs)</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(taxAmount)}</span></div>`;
      }
      invoiceEl.innerHTML = `<div class="invoice-body">
        <div class="invoice-row"><span class="invoice-label">Size</span><span class="invoice-value">${size}</span></div>
        <div class="invoice-row"><span class="invoice-label">Material</span><span class="invoice-value">${material}</span></div>
        <div class="invoice-row"><span class="invoice-label">Quantity</span><span class="invoice-value">${qty} pcs</span></div>
        <div class="invoice-row"><span class="invoice-label">Print Side</span><span class="invoice-value">${side} Side</span></div>
        ${addonsDetailsHTML}
        <div class="invoice-row" style="font-weight: bold;"><span class="invoice-label">Price/Pcs</span><span class="invoice-value">${currentCurrency.symbol} ${formatCurrency(unitPrice)}</span></div>
        ${taxRow}
      </div>
      <div class="invoice-nett"><span>Total Price</span><span>${currentCurrency.symbol} ${formatCurrency(finalTotal)}</span></div>
      <a href="https://www.google.com/" target="_blank" class="btn-link">Download Template</a>`;
    }

    function renderInvitationCardCalculator(container) {
      const sizeButtons = invitationCardData.sizes.map(s => `<button class="btn size-btn ${s === 'A5' ? 'active' : ''}" data-size="${s}">${s}</button>`).join('');
      const qtyOptions = invitationCardData.quantities.map(q => `<option value="${q}" ${q === 100 ? 'selected' : ''}>${q} pcs</option>`).join('');
      const materialCheckboxes = invitationCardData.materials.map((m, i) => `<div class="checkbox-group"><input type="checkbox" name="invCardMaterial" value="${i}" id="mat${i}" ${i === selectedInvCardMaterial ? 'checked' : ''}><label for="mat${i}">${m}</label></div>`).join('');
      let addonsHTML = '';
      invitationCardData.addons.forEach((addon, addonIndex) => {
        const optionButtons = addon.options.map((opt, optionIndex) =>
          `<button class="btn size-btn ${optionIndex === (selectedInvCardAddons[addonIndex] || 0) ? 'active' : ''}" data-addon-index="${addonIndex}" data-option-index="${optionIndex}">${opt.name}</button>`
        ).join('');
        addonsHTML += `<div class="option-box"><label>${addon.name}</label><div class="size-btn-group" id="invCardAddonGroup${addonIndex}">${optionButtons}</div></div>`;
      });
      container.innerHTML = `<div class="calculator-container">
        <h2>Invitation Card</h2>
        <div class="option-box" style="margin-bottom: 20px;"><label>Size</label><div class="size-btn-group" id="invCardSizeBtns">${sizeButtons}</div></div>
        <div class="options-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="option-box"><label for="invCardQty">Quantity</label><select id="invCardQty" onchange="kiraInvitationCard()">${qtyOptions}</select></div>
          <div class="option-box"><label>Print Side</label><div class="size-btn-group" id="invCardSideBtns"><button class="btn size-btn active" data-side="1">1 Side</button><button class="btn size-btn" data-side="2">2 Sides</button></div></div>
          ${addonsHTML}
        </div>
        <div class="option-box" style="margin-top: 20px;"><label>Material</label><div class="modern-checkbox-grid" id="invCardMaterialGroup">${materialCheckboxes}</div></div>
        <div id="invCardInvoice" class="invoice"></div>
      </div>`;
      // Add event listeners for static groups
      ['invCardSizeBtns', 'invCardSideBtns'].forEach(id => {
        document.getElementById(id).addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
            e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            kiraInvitationCard();
          }
        });
      });
      // Add event listeners for dynamic addon groups
      invitationCardData.addons.forEach((_, addonIndex) => {
        document.getElementById(`invCardAddonGroup${addonIndex}`).addEventListener('click', e => {
          if (e.target.tagName !== 'BUTTON') return;
          e.currentTarget.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          selectedInvCardAddons[addonIndex] = parseInt(e.target.dataset.optionIndex);
          kiraInvitationCard();
        });
      });
      const materialGroup = document.getElementById('invCardMaterialGroup');
      materialGroup.addEventListener('change', (e) => {
        if (e.target.name === 'invCardMaterial') {
          materialGroup.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (checkbox !== e.target) checkbox.checked = false;
          });
          e.target.checked = true;
          selectedInvCardMaterial = parseInt(e.target.value);
          kiraInvitationCard();
        }
      });
      kiraInvitationCard();
    }

    function renderSettingsPage(container) {
      const html = `
    <h2>Settings</h2>

    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="settingsTab" role="tablist">
            <li class="me-2" role="presentation">
                <button class="inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg gap-2" data-tab-target="#general" type="button" role="tab">
                    <i class="fas fa-cog"></i> General
                </button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg gap-2" data-tab-target="#pricing" type="button" role="tab">
                    <i class="fas fa-dollar-sign"></i> Pricing
                </button>
            </li>
            <li class="me-2" role="presentation">
                <button class="inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg gap-2" data-tab-target="#exceptions" type="button" role="tab">
                    <i class="fas fa-shield-alt"></i> Exceptions
                </button>
            </li>
            <li role="presentation">
                <button class="inline-flex items-center justify-center p-4 border-b-2 rounded-t-lg gap-2" data-tab-target="#data" type="button" role="tab">
                    <i class="fas fa-database"></i> Data & Backup
                </button>
            </li>
        </ul>
    </div>

    <div id="settingsTabContent">
        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="general" role="tabpanel">
            <div class="settings-panel" style="margin-top:0;">
                <h4>Currency Settings</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-2">Select the currency to be used across all calculators.</p>
                <div class="flex items-center gap-4">
                    <div class="flex items-center p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <img src="https://flagcdn.com/w20/${currentCurrency.country_code}.png" class="mr-3 rounded-sm" alt="${currentCurrency.name} flag">
                        <span>${currentCurrency.name} (${currentCurrency.symbol} - ${currentCurrency.code})</span>
                    </div>
                    <button class="btn btn-secondary" style="width: auto; padding: 10px 20px;" onclick="openCurrencyModal()">Change</button>
                </div>
            </div>
            <div class="settings-panel">
                <h4>Tax & Surcharges</h4>
                <div class="flex items-center justify-between">
                    <div>
                        <label for="taxToggle" class="font-bold text-lg">Enable Tax</label>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Apply a global tax to all final calculations.</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="taxToggle" class="sr-only peer" ${isTaxEnabled ? 'checked' : ''} onchange="document.getElementById('taxPercentInput').style.display = this.checked ? 'block' : 'none'">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div id="taxPercentInput" style="display: ${isTaxEnabled ? 'block' : 'none'}; margin-top: 1rem;">
                    <label for="globalTaxPercent">Tax Rate (%):</label>
                    <input type="number" id="globalTaxPercent" step="0.1" value="${globalTaxPercent}" class="max-w-xs">
                </div>
                <div class="mt-6 pt-4 border-t dark:border-gray-700">
                     <label for="globalGovSurcharge" class="font-bold text-lg">Government Surcharge</label>
                     <input type="number" id="globalGovSurcharge" step="1" value="${globalGovSurchargePercent}" class="max-w-xs mt-2" />
                </div>
                 <button id="applyGlobalPrices" class="btn btn-secondary" style="width: auto; padding: 10px 20px; margin-top: 24px;">Save General Settings</button>
            </div>
        </div>

        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="pricing" role="tabpanel">
            <div class="settings-panel" style="margin-top:0;">
                <h4>Global Prices</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div><label>Eyelet Price (${currentCurrency.symbol}/pcs):</label><input type="number" id="globalEyeletPrice" step="0.01" value="${globalEyeletPrice.toFixed(2)}"/></div>
                    <div><label>Glue Price (${currentCurrency.symbol}/ft):</label><input type="number" id="globalGluePrice" step="0.01" value="${globalGluePrice.toFixed(2)}"/></div>
                    <div><label>Pipe Price (${currentCurrency.symbol}/ft):</label><input type="number" id="globalPipePrice" step="0.01" value="${globalPipePrice.toFixed(2)}"/></div>
                </div>
            </div>
             <div class="settings-panel">
                <label for="categorySelect"><h4>Material & Rate Management</h4></label>
                <select id="categorySelect" onchange="updateSettingsPage()">
                    <option value="largeFormat">Large Format</option>
                    <option value="stand">Stand</option>
                    <option value="signboard">Signboard</option>
                    <option value="invitationCard">Invitation Card</option>
                    <option value="businessCard">Business Card</option>
                </select>
                <div id="settingsTableDiv" style="overflow-x: auto; margin-top: 1rem;"></div>
                <div id="addMaterialForm" style="display: none;">
                    <h3 id="formTitle">Add New Material</h3>
                    <label for="materialName">Name:</label>
                    <input type="text" id="materialName"/>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div><label for="customerPrice">Customer Price (${currentCurrency.symbol}):</label><input type="number" id="customerPrice" step="0.01"/></div>
                        <div><label for="agentPrice">Agent Price (${currentCurrency.symbol}):</label><input type="number" id="agentPrice" step="0.01"/></div>
                    </div>
                    <div id="extraFields"></div>
                    <button class="btn btn-primary" onclick="saveMaterial()"><span id="saveButtonLabel">Add Material</span></button>
                </div>
            </div>
        </div>

        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="exceptions" role="tabpanel">
             <div class="settings-panel" style="margin-top:0;">
                <h2 class="text-xl font-bold mb-4">Exception Rules</h2>
                <div id="glue-exception-heading">
                    <button type="button" class="flex items-center justify-between w-full font-bold text-lg text-left text-gray-700 dark:text-gray-400 custom-accordion-toggle" data-accordion-target="#glue-exception-content">
                        <span>Free Glue Exception Sizes</span>
                        <svg class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                    </button>
                    <div id="glue-exception-content" class="hidden" style="transition: max-height 0.3s ease-out; max-height: 0; overflow: hidden;">
                        <p class="text-sm text-gray-500 my-4 dark:text-gray-400">Define sizes (in feet) exempt from glue charges. The check is inclusive (e.g., 2ft x 6ft also covers 1.5ft x 5ft).</p>
                        <div id="glueExceptionTableContainer"></div>
                        <div class="flex items-end gap-4 mt-4">
                            <div><label for="glueExceptionW">Width (ft):</label><input type="number" id="glueExceptionW" step="0.1" class="p-2"/></div>
                            <div><label for="glueExceptionH">Height (ft):</label><input type="number" id="glueExceptionH" step="0.1" class="p-2"/></div>
                            <button class="btn btn-secondary btn-sm" style="width: auto; margin: 0 0 4px 0;" onclick="addGlueExceptionSize()">Add Size</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t dark:border-gray-700">
                    <h2 id="eyelet-exception-heading">
                        <button type="button" class="flex items-center justify-between w-full font-bold text-lg text-left text-gray-700 dark:text-gray-400 custom-accordion-toggle" data-accordion-target="#eyelet-exception-content">
                            <span>Auto Eyelet Exception Sizes</span>
                            <svg class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                        </button>
                    </h2>
                    <div id="eyelet-exception-content" class="hidden" style="transition: max-height 0.3s ease-out; max-height: 0; overflow: hidden;">
                        <p class="text-sm text-gray-500 my-4 dark:text-gray-400">Define sizes (in feet) that should receive a fixed number of 4 eyelets automatically.</p>
                        <div id="eyeletExceptionTableContainer"></div>
                        <div class="flex items-end gap-4 mt-4">
                            <div><label for="eyeletExceptionW">Width (ft):</label><input type="number" id="eyeletExceptionW" step="0.1" class="p-2"/></div>
                            <div><label for="eyeletExceptionH">Height (ft):</label><input type="number" id="eyeletExceptionH" step="0.1" class="p-2"/></div>
                            <button class="btn btn-secondary btn-sm" style="width: auto; margin: 0 0 4px 0;" onclick="addEyeletExceptionSize()">Add Size</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="data" role="tabpanel">
            <div class="settings-panel" style="margin-top:0;">
                <h4>Data Management</h4>
                <p class="text-gray-600 dark:text-gray-400">Export all your current pricing, global variables, and exception rules to a single JSON file for backup. You can import this file later to restore your settings.</p>
                <div class="flex gap-4 mt-4">
                    <button class="btn btn-secondary" style="width: auto;" onclick="exportSettings()">
                        <i class="fas fa-file-export mr-2"></i> Export Settings
                    </button>
                    <button class="btn btn-secondary" style="width: auto;" onclick="importSettings()">
                        <i class="fas fa-file-import mr-2"></i> Import Settings
                    </button>
                </div>
                <div class="mt-4 p-3 text-sm text-yellow-800 rounded-lg bg-yellow-50 dark:bg-gray-700 dark:text-yellow-300" role="alert">
                  <span class="font-medium">Warning:</span> Importing a file will overwrite all your existing settings. Please be sure before proceeding.
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h2 id="reset-heading">
                        <button type="button" class="flex items-center justify-between w-full font-bold text-lg text-left text-red-500 custom-accordion-toggle" data-accordion-target="#reset-content">
                            <span>RESET DATA</span>
                            <svg class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                        </button>
                    </h2>
                    <div id="reset-content" class="hidden" style="transition: max-height 0.3s ease-out; max-height: 0; overflow: hidden;">
                        <div class="mt-4 p-3 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-700 dark:text-red-400" role="alert">
                          <span class="font-medium">Warning:</span> Apply Reset will overwrite all your existing settings and revert to original Dev Hardcode. Please be sure before proceeding.
                        </div>
                        <button class="btn btn-danger" style="width: auto; padding: 10px 20px; margin-top: 16px;" onclick="resetToHardcode()">
                            Reset To Original
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  `;
      container.innerHTML = html;
      // --- START: CUSTOM FAST UI LOGIC ---
      const activeClasses = ['text-blue-600', 'dark:text-blue-500', 'border-blue-600', 'dark:border-blue-500'];
      const inactiveClasses = ['text-gray-500', 'dark:text-gray-400', 'border-transparent', 'hover:border-gray-300', 'dark:hover:text-gray-300'];
      const tabButtons = document.querySelectorAll('#settingsTab button');
      const tabContents = document.querySelectorAll('#settingsTabContent > div');
      const showTab = (targetId) => {
        tabContents.forEach(content => {
          if ('#' + content.id === targetId) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
        });
        tabButtons.forEach(button => {
          if (button.dataset.tabTarget === targetId) {
            button.classList.add(...activeClasses);
            button.classList.remove(...inactiveClasses);
          } else {
            button.classList.remove(...activeClasses);
            button.classList.add(...inactiveClasses);
          }
        });
      };
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          showTab(button.dataset.tabTarget);
        });
      });
      document.querySelectorAll('.custom-accordion-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.dataset.accordionTarget;
          const targetContent = document.querySelector(targetId);
          const icon = button.querySelector('svg');
          if (targetContent) {
            if (targetContent.classList.contains('hidden')) {
              targetContent.classList.remove('hidden');
              // Use a short timeout to allow the 'hidden' class to be removed before calculating scrollHeight
              setTimeout(() => {
                targetContent.style.maxHeight = targetContent.scrollHeight + "px";
                if (icon) icon.style.transform = 'rotate(0deg)';
              }, 10);
            } else {
              targetContent.style.maxHeight = '0';
              if (icon) icon.style.transform = 'rotate(180deg)';
              // Add a listener to hide it completely after the transition
              targetContent.addEventListener('transitionend', () => {
                targetContent.classList.add('hidden');
              }, {
                once: true
              });
            }
          }
        });
      });
      // Show the default tab and populate its content
      showTab('#pricing');
      updateSettingsPage();
      renderGlueExceptionTable();
      renderEyeletExceptionTable();
      // Add event listener for the "Save" button in the "General" tab
      document.getElementById('applyGlobalPrices').addEventListener('click', () => {
        globalGovSurchargePercent = parseFloat(document.getElementById('globalGovSurcharge').value) || 0;
        isTaxEnabled = document.getElementById('taxToggle').checked;
        globalTaxPercent = parseFloat(document.getElementById('globalTaxPercent').value) || 0;
        localStorage.setItem('isTaxEnabled', isTaxEnabled);
        localStorage.setItem('globalTaxPercent', globalTaxPercent);
        globalEyeletPrice = parseFloat(document.getElementById('globalEyeletPrice').value) || 0;
        globalGluePrice = parseFloat(document.getElementById('globalGluePrice').value) || 0;
        globalPipePrice = parseFloat(document.getElementById('globalPipePrice').value) || 0;
        alert(`Settings updated`);
        renderSettingsPage(document.getElementById('contentArea'));
      });
      // --- END: CUSTOM FAST UI LOGIC ---
    }
    /**
     * Gathers all settings into a single object and downloads it as a JSON file.
     */
    function exportSettings() {
      const settingsToExport = {
        // Pricing data
        materials: materials,
        stands: stands,
        signboardMaterials: signboardMaterials,
        invitationCardData: invitationCardData,
        idCardRates: idCardRates,
        businessCardData: businessCardData,
        sublimationVariations: sublimationVariations,
        extraSizeCost: extraSizeCost,
        // Global settings
        globalEyeletPrice: globalEyeletPrice,
        globalGluePrice: globalGluePrice,
        globalPipePrice: globalPipePrice,
        globalGovSurchargePercent: globalGovSurchargePercent,
        isTaxEnabled: isTaxEnabled,
        globalTaxPercent: globalTaxPercent,
        currentCurrencyCode: currentCurrency.code,
        // Exception lists
        glueExceptionSizes: glueExceptionSizes,
        eyeletExceptionSizes: eyeletExceptionSizes,
      };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(settingsToExport, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "calculator-settings.json");
      document.body.appendChild(downloadAnchorNode); // required for firefox
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      alert("Settings have been exported as 'calculator-settings.json'");
    }
    /**
     * Imports settings from a user-selected JSON file.
     */
    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.readAsText(file, 'UTF-8');
        reader.onload = readerEvent => {
          try {
            const content = readerEvent.target.result;
            const newSettings = JSON.parse(content);
            // Confirmation before overwriting
            if (!confirm("Are you sure you want to import these settings? This will overwrite all current prices and rules.")) {
              return;
            }
            // Apply imported settings
            // Pricing data
            if (newSettings.materials) materials = newSettings.materials;
            if (newSettings.stands) stands = newSettings.stands;
            if (newSettings.signboardMaterials) signboardMaterials = newSettings.signboardMaterials;
            if (newSettings.invitationCardData) invitationCardData = newSettings.invitationCardData;
            if (newSettings.idCardRates) idCardRates = newSettings.idCardRates;
            if (newSettings.businessCardData) businessCardData = newSettings.businessCardData;
            if (newSettings.sublimationVariations) sublimationVariations = newSettings.sublimationVariations;
            if (newSettings.extraSizeCost) extraSizeCost = newSettings.extraSizeCost;
            // Global settings
            if (newSettings.globalEyeletPrice) globalEyeletPrice = newSettings.globalEyeletPrice;
            if (newSettings.globalGluePrice) globalGluePrice = newSettings.globalGluePrice;
            if (newSettings.globalPipePrice) globalPipePrice = newSettings.globalPipePrice;
            if (newSettings.globalGovSurchargePercent) globalGovSurchargePercent = newSettings.globalGovSurchargePercent;
            if (newSettings.isTaxEnabled) isTaxEnabled = newSettings.isTaxEnabled;
            if (newSettings.globalTaxPercent) globalTaxPercent = newSettings.globalTaxPercent;
            if (newSettings.currentCurrencyCode) {
              const foundCurrency = currencies.find(c => c.code === newSettings.currentCurrencyCode);
              if (foundCurrency) {
                currentCurrency = foundCurrency;
              }
            }
            // Exception lists
            if (newSettings.glueExceptionSizes) glueExceptionSizes = newSettings.glueExceptionSizes;
            if (newSettings.eyeletExceptionSizes) eyeletExceptionSizes = newSettings.eyeletExceptionSizes;
            alert("Settings imported successfully!");
            renderSettingsPage(document.getElementById('contentArea')); // Refresh the page to show new settings
          } catch (error) {
            alert("Error importing file. Please ensure it is a valid settings file.\n\n" + error);
          }
        }
      };
      input.click();
    }

    function resetToHardcode() {
      if (confirm("Warning: This will overwrite all your existing settings and revert to the original hardcoded values. Are you sure you want to proceed?")) {
        // List of all localStorage keys used by the app
        const keysToRemove = [
          'selectedCurrency',
          'isTaxEnabled',
          'globalTaxPercent',
          'eyeletExceptionSizes',
        ];
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
        });
        alert("All settings have been reset to their original values. The application will now reload.");
        location.reload();
      }
    }
    document.addEventListener('DOMContentLoaded', () => loadPage('home'));

    function getCategoryArray() {
      const category = document.getElementById("categorySelect").value;
      if (category === "largeFormat") return materials;
      if (category === "stand") return stands;
      if (category === "signboard") return signboardMaterials;
      return [];
    }

    function updateSettingsPage() {
      updateExtraFields();
      updateSettingsTable();
      resetForm();
    }

    function updateExtraFields() {
      const category = document.getElementById("categorySelect").value;
      let extraHTML = "";
      if (category === "largeFormat" || category === "signboard") {
        extraHTML = `<div class="modern-checkbox-grid" style="grid-template-columns: 1fr; margin-top: 16px;"><div class="checkbox-group"><input type="checkbox" id="isSimple"><label for="isSimple">Simple Material (No Eyelet/Pipe)</label></div></div>`;
      }
      document.getElementById("extraFields").innerHTML = extraHTML;
    }

    function updateSettingsTable() {
      const category = document.getElementById("categorySelect").value;
      const addMaterialForm = document.getElementById("addMaterialForm");
      if (category === 'invitationCard') {
        addMaterialForm.style.display = 'none';
        // Correctly initialize the edit state for each addon
        invitationCardEditState = {
          base: false,
          material: false,
          addons: invitationCardData.addons.map(() => false)
        };
        renderInvitationCardSettingsTable();
      } else if (category === 'businessCard') {
        addMaterialForm.style.display = 'none';
        businessCardEditState = {
          materials: false,
          addons: businessCardData.addons.map(() => false)
        };
        renderBusinessCardSettingsTable();
      } else {
        addMaterialForm.style.display = 'block';
        renderStandardSettingsTable();
      }
    }

    function renderStandardSettingsTable() {
      const arr = getCategoryArray();
      const category = document.getElementById("categorySelect").value;
      let tableHTML = "<table class='settings-table'><thead><tr><th>#</th><th>Name</th><th>Customer Price</th><th>Agent Price</th>";
      if (category === "largeFormat" || category === "signboard") tableHTML += "<th>Simple</th>";
      tableHTML += "<th>Actions</th></tr></thead><tbody>";
      arr.forEach((item, index) => {
        tableHTML += `<tr><td>${index + 1}</td><td>${item.name}</td><td>${currentCurrency.symbol} ${formatCurrency(item.customerPrice)}</td><td>${currentCurrency.symbol} ${formatCurrency(item.agentPrice)}</td>`;
        if (category === "largeFormat" || category === "signboard") {
          tableHTML += `<td>${item.simple ? "Yes" : "No"}</td>`;
        }
        tableHTML += `<td><div class="action-buttons"><button class="btn btn-sm btn-secondary" onclick='editMaterial(${index})'>Edit</button><button class="btn btn-sm btn-danger" onclick='deleteMaterial(${index})'>Delete</button></div></td></tr>`;
      });
      tableHTML += "</tbody></table>";
      document.getElementById("settingsTableDiv").innerHTML = tableHTML;
    }

    function toggleInvitationCardEditMode(section, isEditing, index = null) {
      if (isEditing) {
        // Create a backup of the current data when entering edit mode
        originalInvitationCardData = JSON.parse(JSON.stringify(invitationCardData));
      } else {
        // If canceling, restore the data from the backup
        if (Object.keys(originalInvitationCardData).length > 0) {
          invitationCardData = JSON.parse(JSON.stringify(originalInvitationCardData));
        }
      }
      if (section === 'base') {
        invitationCardEditState.base = isEditing;
      } else if (section === 'material') {
        invitationCardEditState.material = isEditing;
      } else if (section === 'addons') {
        invitationCardEditState.addons[index] = isEditing;
      }
      renderInvitationCardSettingsTable();
    }

    function renderInvitationCardSettingsTable() {
      let html = '';
      const isBaseEditing = invitationCardEditState.base;
      const isMaterialEditing = invitationCardEditState.material;
      // --- Base Prices Section ---
      html += `<h4>Base Prices (Per Piece)</h4><table class="settings-table" id="basePricesTable"><thead><tr><th>Qty / Size</th>`;
      invitationCardData.sizes.forEach(size => {
        html += `<th colspan="2">${size}</th>`;
      });
      html += `</tr><tr><th></th>`;
      invitationCardData.sizes.forEach(() => {
        html += `<th class="header-2line">1-Side</th><th class="header-2line">2-Side</th>`;
      });
      html += `</tr></thead><tbody>`;
      invitationCardData.quantities.forEach(qty => {
        html += `<tr><td><strong>${qty} pcs</strong></td>`;
        invitationCardData.sizes.forEach(size => {
          const price1 = invitationCardData.basePrice[size]?.[qty]?.[1] || 0;
          const price2 = invitationCardData.basePrice[size]?.[qty]?.[2] || 0;
          html += isBaseEditing ? `<td><input type="number" step="0.01" value="${price1.toFixed(2)}" data-size="${size}" data-qty="${qty}" data-side="1"></td>` : `<td>${price1.toFixed(2)}</td>`;
          html += isBaseEditing ? `<td><input type="number" step="0.01" value="${price2.toFixed(2)}" data-size="${size}" data-qty="${qty}" data-side="2"></td>` : `<td>${price2.toFixed(2)}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; margin-bottom: 24px;">
              <div>${isBaseEditing ? `<button class="btn btn-sm btn-secondary" onclick="addInvitationCardQty()">+ Add Qty</button>` : ''}</div>
              <div class="action-buttons">${isBaseEditing ?
                  `<button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('base', false)">Cancel</button><button class="btn btn-sm btn-primary" style="width: auto; margin-top:0;" onclick="saveInvitationCardSettings('base')">Done</button>` :
                  `<button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('base', true)">Edit</button><button class="btn btn-sm btn-danger" onclick="removeInvitationCardQty()">Remove</button>`
              }</div></div>`;
      // --- Material Add-ons Section ---
      html += `<h4>Material Add-on Prices</h4><table class="settings-table" id="materialAddonTable"><thead><tr><th>Material / Size</th>`;
      invitationCardData.sizes.forEach(size => {
        html += `<th>${size}</th>`;
      });
      html += `</tr></thead><tbody>`;
      invitationCardData.materials.forEach(mat => {
        html += `<tr><td><strong>${mat}</strong></td>`;
        invitationCardData.sizes.forEach(size => {
          const price = invitationCardData.materialAddOn[size]?.[mat] || 0;
          html += isMaterialEditing ? `<td><input type="number" step="0.01" value="${price.toFixed(2)}" data-size="${size}" data-material="${mat}"></td>` : `<td>+${price.toFixed(2)}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; margin-bottom: 24px;">
              <div>${isMaterialEditing ? `<button class="btn btn-sm btn-secondary" onclick="addInvitationCardMaterial()">+ Add Material</button>` : ''}</div>
              <div class="action-buttons">${isMaterialEditing ?
                  `<button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('material', false)">Cancel</button><button class="btn btn-sm btn-primary" style="width: auto; margin-top:0;" onclick="saveInvitationCardSettings('material')">Done</button>` :
                  `<button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('material', true)">Edit</button><button class="btn btn-sm btn-danger" onclick="removeInvitationCardMaterial()">Remove</button>`
              }</div></div>`;
      // --- Dynamic Add-ons Section ---
      html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; border-top: 2px solid var(--border-color); padding-top: 24px;">
                    <h4>Finishing Add-ons</h4>
                    <div class="action-buttons">
                      <button class="btn btn-sm btn-secondary" onclick="addInvitationCardSize()">+ Add Size</button>
                      <button class="btn btn-sm btn-danger" onclick="removeInvitationCardSize()">- Remove Size</button>
                      <button class="btn btn-sm btn-primary" style="width:auto; margin-top:0;" onclick="addInvitationCardAddonType()">+ Add New Finishing Type</button>
                    </div>
                  </div>`;
      invitationCardData.addons.forEach((addon, addonIndex) => {
        const isAddonEditing = invitationCardEditState.addons[addonIndex];
        html += `<div class="settings-panel" style="margin-top: 16px; padding: 16px; border: 1px solid var(--accent-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h5>${addon.name}</h5>
                        <div class="action-buttons">
                            ${isAddonEditing ?
          `<button class="btn btn-sm btn-secondary" onclick="addInvitationCardAddonOption(${addonIndex})">+ Add Option</button>
                                 <button class="btn btn-sm btn-danger" onclick="removeInvitationCardAddonType(${addonIndex})">Delete Type</button>
                                 <button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('addons', false, ${addonIndex})">Cancel</button>
                                 <button class="btn btn-sm btn-primary" style="width: auto; margin-top:0;" onclick="saveInvitationCardSettings('addons', ${addonIndex})">Done</button>` :
          `<button class="btn btn-sm btn-secondary" onclick="toggleInvitationCardEditMode('addons', true, ${addonIndex})">Edit</button>`
        }
                        </div>
                    </div>
                    <table class="settings-table"><thead><tr><th>Option</th>`;
        invitationCardData.sizes.forEach(size => {
          html += `<th>${size}</th>`;
        });
        html += `${isAddonEditing ? '<th>Actions</th>' : ''}</tr></thead><tbody>`;
        addon.options.forEach((option, optionIndex) => {
          html += `<tr><td>${isAddonEditing ? `<input type="text" value="${option.name}" data-addon-index="${addonIndex}" data-option-index="${optionIndex}" data-field="name">` : option.name}</td>`;
          invitationCardData.sizes.forEach(size => {
            const price = option.prices[size] || 0;
            html += isAddonEditing ? `<td><input type="number" step="0.01" value="${price.toFixed(2)}" data-addon-index="${addonIndex}" data-option-index="${optionIndex}" data-size="${size}" data-field="price"></td>` : `<td>+${price.toFixed(2)}</td>`;
          });
          html += `${isAddonEditing ? `<td><button class="btn btn-sm btn-danger" onclick="removeInvitationCardAddonOption(${addonIndex}, ${optionIndex})">Remove</button></td>` : ''}</tr>`;
        });
        html += `</tbody></table></div>`;
      });
      document.getElementById("settingsTableDiv").innerHTML = html;
    }

    function saveInvitationCardSettings(section, index = null) {
      if (section === 'base') {
        document.querySelectorAll('#basePricesTable input[data-side]').forEach(input => {
          const size = input.dataset.size,
            qty = input.dataset.qty,
            side = input.dataset.side,
            value = parseFloat(input.value);
          if (invitationCardData.basePrice[size]?.[qty]) invitationCardData.basePrice[size][qty][side] = value;
        });
      } else if (section === 'material') {
        document.querySelectorAll('#materialAddonTable input[data-material]').forEach(input => {
          const size = input.dataset.size,
            material = input.dataset.material,
            value = parseFloat(input.value);
          if (invitationCardData.materialAddOn[size]) invitationCardData.materialAddOn[size][material] = value;
        });
      } else if (section === 'addons') {
        const addon = invitationCardData.addons[index];
        addon.options.forEach((option, optionIndex) => {
          const nameInput = document.querySelector(`input[data-addon-index="${index}"][data-option-index="${optionIndex}"][data-field="name"]`);
          option.name = nameInput.value;
          invitationCardData.sizes.forEach(size => {
            const priceInput = document.querySelector(`input[data-addon-index="${index}"][data-option-index="${optionIndex}"][data-size="${size}"]`);
            option.prices[size] = parseFloat(priceInput.value);
          });
        });
      }
      alert(`Invitation Card ${section} settings saved successfully!`);
      // Clear the backup so the next "edit" action saves the new state
      originalInvitationCardData = {};
      toggleInvitationCardEditMode(section, false, index);
    }

    function addInvitationCardQty() {
      const newQty = prompt("Enter new quantity tier (e.g., 2000):");
      if (newQty && !isNaN(parseInt(newQty))) {
        const qtyNum = parseInt(newQty);
        if (!invitationCardData.quantities.includes(qtyNum)) {
          invitationCardData.quantities.push(qtyNum);
          invitationCardData.quantities.sort((a, b) => a - b);
          invitationCardData.sizes.forEach(size => {
            invitationCardData.basePrice[size][qtyNum] = {
              1: 0,
              2: 0
            };
          });
          renderInvitationCardSettingsTable();
        } else {
          alert("This quantity already exists.");
        }
      } else if (newQty) {
        alert("Please enter a valid number.");
      }
    }

    function addInvitationCardSize() {
      const newSize = prompt("Enter new size name (e.g., A7):");
      if (newSize && !invitationCardData.sizes.includes(newSize.toUpperCase())) {
        const sizeKey = newSize.toUpperCase();
        invitationCardData.sizes.push(sizeKey);
        // Sync with Base Prices
        invitationCardData.basePrice[sizeKey] = {};
        invitationCardData.quantities.forEach(qty => {
          invitationCardData.basePrice[sizeKey][qty] = {
            1: 0,
            2: 0
          };
        });
        // Sync with Material Add-ons
        invitationCardData.materialAddOn[sizeKey] = {};
        invitationCardData.materials.forEach(mat => {
          invitationCardData.materialAddOn[sizeKey][mat] = 0;
        });
        // Sync with ALL other Add-ons
        invitationCardData.addons.forEach(addon => {
          addon.options.forEach(option => {
            option.prices[sizeKey] = 0;
          });
        });
        renderInvitationCardSettingsTable();
      } else if (newSize) {
        alert("This size already exists.");
      }
    }

    function addInvitationCardMaterial() {
      const newMaterial = prompt("Enter new material name (e.g., Ivory Card 260gsm):");
      if (newMaterial && !invitationCardData.materials.includes(newMaterial)) {
        invitationCardData.materials.push(newMaterial);
        invitationCardData.sizes.forEach(size => {
          invitationCardData.materialAddOn[size][newMaterial] = 0;
        });
        renderInvitationCardSettingsTable();
      } else if (newMaterial) {
        alert("This material already exists.");
      }
    }

    function removeInvitationCardQty() {
      const itemToRemove = prompt(`Enter quantity to remove from: ${invitationCardData.quantities.join(', ')}`);
      if (itemToRemove && !isNaN(parseInt(itemToRemove))) {
        const qtyNum = parseInt(itemToRemove);
        const index = invitationCardData.quantities.indexOf(qtyNum);
        if (index > -1) {
          invitationCardData.quantities.splice(index, 1);
          invitationCardData.sizes.forEach(size => {
            delete invitationCardData.basePrice[size][qtyNum];
          });
          alert(`Quantity ${qtyNum} removed.`);
          renderInvitationCardSettingsTable();
        } else {
          alert(`Quantity ${qtyNum} not found.`);
        }
      }
    }

    function removeInvitationCardSize() {
      const itemToRemove = prompt(`Enter size to remove from: ${invitationCardData.sizes.join(', ')}`);
      if (itemToRemove) {
        const sizeKey = itemToRemove.toUpperCase();
        const index = invitationCardData.sizes.indexOf(sizeKey);
        if (index > -1) {
          invitationCardData.sizes.splice(index, 1);
          delete invitationCardData.basePrice[sizeKey];
          delete invitationCardData.materialAddOn[sizeKey];
          // Remove from all other add-ons
          invitationCardData.addons.forEach(addon => {
            addon.options.forEach(option => {
              delete option.prices[sizeKey];
            });
          });
          alert(`Size ${sizeKey} removed.`);
          renderInvitationCardSettingsTable();
        } else {
          alert(`Size ${sizeKey} not found.`);
        }
      }
    }

    function removeInvitationCardMaterial() {
      const itemToRemove = prompt(`Enter material to remove from:\n${invitationCardData.materials.join('\n')}`);
      if (itemToRemove) {
        const index = invitationCardData.materials.indexOf(itemToRemove);
        if (index > -1) {
          invitationCardData.materials.splice(index, 1);
          invitationCardData.sizes.forEach(size => {
            delete invitationCardData.materialAddOn[size][itemToRemove];
          });
          alert(`Material "${itemToRemove}" removed.`);
          renderInvitationCardSettingsTable();
        } else {
          alert(`Material "${itemToRemove}" not found.`);
        }
      }
    }

    function renderBusinessCardSettingsTable() {
      let html = '';
      const isMaterialsEditing = businessCardEditState.materials;
      // Materials Table
      html += `<h4>Material Prices (Per Box)</h4>
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 16px;">
            ${isMaterialsEditing ?
        `<button class="btn btn-sm btn-secondary" onclick="addBusinessCardMaterial()">+ Add Material</button>
                 <button class="btn btn-sm btn-danger" onclick="removeBusinessCardMaterial()">- Remove Material</button>
                 <button class="btn btn-sm btn-secondary" onclick="toggleBusinessCardEditMode('materials', false)">Cancel</button>
                 <button class="btn btn-sm btn-primary" style="width: auto; margin-top:0;" onclick="saveBusinessCardSettings('materials')">Done</button>` :
        `<button class="btn btn-sm btn-secondary" onclick="toggleBusinessCardEditMode('materials', true)">Edit Materials</button>`
      }
        </div>
        <table class="settings-table"><thead><tr><th rowspan="2">Material</th>`;
      businessCardData.quantities.forEach(q => {
        html += `<th colspan="2">${q.label}</th>`;
      });
      html += `</tr><tr>`;
      businessCardData.quantities.forEach(() => {
        html += `<th>1-Side</th><th>2-Side</th>`;
      });
      html += `</tr></thead><tbody>`;
      businessCardData.materials.forEach((mat, matIndex) => {
        html += `<tr><td><strong>${mat.name}</strong></td>`;
        businessCardData.quantities.forEach(q => {
          const price1 = mat.p1[q.value] || 0;
          const price2 = mat.p2[q.value] || 0;
          html += isMaterialsEditing ? `<td><input type="number" step="0.01" value="${price1.toFixed(2)}" data-mat-index="${matIndex}" data-qty="${q.value}" data-side="p1"></td>` : `<td>${price1.toFixed(2)}</td>`;
          html += isMaterialsEditing ? `<td><input type="number" step="0.01" value="${price2.toFixed(2)}" data-mat-index="${matIndex}" data-qty="${q.value}" data-side="p2"></td>` : `<td>${price2.toFixed(2)}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      // Addons Section
      html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px;"><h4>Add-on Prices</h4><button class="btn btn-sm btn-secondary" onclick="addBusinessCardAddonType()">+ Add New Add-on Type</button></div>`;
      businessCardData.addons.forEach((addon, addonIndex) => {
        const isAddonEditing = businessCardEditState.addons[addonIndex];
        html += `<div class="settings-panel" style="margin-top: 16px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h5>${addon.name}</h5>
                        <div class="action-buttons">
                            ${isAddonEditing ?
          `<button class="btn btn-sm btn-secondary" onclick="addBusinessCardAddonOption(${addonIndex})">+ Add Option</button>
                                 <button class="btn btn-sm btn-danger" onclick="removeBusinessCardAddonType(${addonIndex})">Delete Type</button>
                                 <button class="btn btn-sm btn-secondary" onclick="toggleBusinessCardEditMode('addons', false, ${addonIndex})">Cancel</button>
                                 <button class="btn btn-sm btn-primary" style="width: auto; margin-top:0;" onclick="saveBusinessCardSettings('addons', ${addonIndex})">Done</button>` :
          `<button class="btn btn-sm btn-secondary" onclick="toggleBusinessCardEditMode('addons', true, ${addonIndex})">Edit</button>`
        }
                        </div>
                    </div>
                    <table class="settings-table"><thead><tr><th>Option</th><th>Price (RM)</th>${isAddonEditing ? '<th>Actions</th>' : ''}</tr></thead><tbody>`;
        addon.options.forEach((option, optionIndex) => {
          html += `<tr>
                        <td>${isAddonEditing ? `<input type="text" value="${option.name || option.label}" data-addon-index="${addonIndex}" data-option-index="${optionIndex}" data-field="name">` : (option.name || option.label)}</td>
                        <td>${isAddonEditing ? `<input type="number" step="0.01" value="${option.price.toFixed(2)}" data-addon-index="${addonIndex}" data-option-index="${optionIndex}" data-field="price">` : option.price.toFixed(2)}</td>
                        ${isAddonEditing ? `<td><button class="btn btn-sm btn-danger" onclick="removeBusinessCardAddonOption(${addonIndex}, ${optionIndex})">Remove</button></td>` : ''}
                     </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      document.getElementById("settingsTableDiv").innerHTML = html;
    }

    function addInvitationCardAddonType() {
      const name = prompt("Enter new add-on type name (e.g., Folding):");
      if (!name) return;
      const newAddon = {
        name: name,
        options: []
      };
      const defaultOption = {
        name: "None",
        prices: {}
      };
      invitationCardData.sizes.forEach(size => {
        defaultOption.prices[size] = 0;
      });
      newAddon.options.push(defaultOption);
      invitationCardData.addons.push(newAddon);
      invitationCardEditState.addons = invitationCardData.addons.map(() => false);
      renderInvitationCardSettingsTable();
    }

    function removeInvitationCardAddonType(addonIndex) {
      const addonName = invitationCardData.addons[addonIndex].name;
      if (confirm(`Are you sure you want to delete the entire '${addonName}' add-on type?`)) {
        invitationCardData.addons.splice(addonIndex, 1);
        invitationCardEditState.addons.splice(addonIndex, 1);
        renderInvitationCardSettingsTable();
      }
    }

    function addInvitationCardAddonOption(addonIndex) {
      const name = prompt(`Enter new option name for ${invitationCardData.addons[addonIndex].name}:`);
      if (!name) return;
      const newOption = {
        name: name,
        prices: {}
      };
      invitationCardData.sizes.forEach(size => {
        const price = parseFloat(prompt(`Enter price for ${name} at size ${size}:`));
        newOption.prices[size] = isNaN(price) ? 0 : price;
      });
      invitationCardData.addons[addonIndex].options.push(newOption);
      renderInvitationCardSettingsTable();
    }

    function removeInvitationCardAddonOption(addonIndex, optionIndex) {
      const addon = invitationCardData.addons[addonIndex];
      const option = addon.options[optionIndex];
      if (confirm(`Are you sure you want to remove the option '${option.name}' from '${addon.name}'?`)) {
        addon.options.splice(optionIndex, 1);
        renderInvitationCardSettingsTable();
      }
    }

    function toggleBusinessCardEditMode(section, isEditing, index = null) {
      if (isEditing) {
        originalBusinessCardData = JSON.parse(JSON.stringify(businessCardData));
      }
      if (section === 'materials') {
        businessCardEditState.materials = isEditing;
      } else if (section === 'addons') {
        businessCardEditState.addons[index] = isEditing;
      }
      renderBusinessCardSettingsTable();
    }

    function cancelBusinessCardEdit(section, index = null) {
      businessCardData = JSON.parse(JSON.stringify(originalBusinessCardData));
      toggleBusinessCardEditMode(section, false, index);
    }

    function saveBusinessCardSettings(section, index = null) {
      if (section === 'materials') {
        document.querySelectorAll('#settingsTableDiv input[data-mat-index]').forEach(input => {
          const matIndex = parseInt(input.dataset.matIndex);
          const qty = input.dataset.qty;
          const side = input.dataset.side;
          const value = parseFloat(input.value);
          businessCardData.materials[matIndex][side][qty] = value;
        });
        alert('Business Card materials saved successfully!');
        toggleBusinessCardEditMode('materials', false);
      } else if (section === 'addons') {
        const addon = businessCardData.addons[index];
        addon.options.forEach((option, optionIndex) => {
          const nameInput = document.querySelector(`input[data-addon-index="${index}"][data-option-index="${optionIndex}"][data-field="name"]`);
          const priceInput = document.querySelector(`input[data-addon-index="${index}"][data-option-index="${optionIndex}"][data-field="price"]`);
          if (option.hasOwnProperty('label')) {
            option.label = nameInput.value;
            option.value = nameInput.value.toLowerCase().replace(/\s+/g, '');
          } else {
            option.name = nameInput.value;
          }
          option.price = parseFloat(priceInput.value);
        });
        alert(`'${addon.name}' options saved successfully!`);
        toggleBusinessCardEditMode('addons', false, index);
      }
    }

    function addBusinessCardMaterial() {
      const name = prompt("Enter new material name:");
      if (!name) return;
      const newMaterial = {
        name: name,
        p1: {},
        p2: {}
      };
      businessCardData.quantities.forEach(q => {
        newMaterial.p1[q.value] = 0;
        newMaterial.p2[q.value] = 0;
      });
      businessCardData.materials.push(newMaterial);
      renderBusinessCardSettingsTable();
    }

    function removeBusinessCardMaterial() {
      const options = businessCardData.materials.map((m, i) => `${i + 1}: ${m.name}`).join('\n');
      const choice = prompt(`Enter the number of the material to remove:\n${options}`);
      const index = parseInt(choice) - 1;
      if (!isNaN(index) && index >= 0 && index < businessCardData.materials.length) {
        if (confirm(`Are you sure you want to remove '${businessCardData.materials[index].name}'?`)) {
          businessCardData.materials.splice(index, 1);
          renderBusinessCardSettingsTable();
        }
      } else {
        alert("Invalid selection.");
      }
    }

    function addBusinessCardAddonType() {
      const name = prompt("Enter new add-on type name (e.g., Hot Stamping):");
      if (!name) return;
      businessCardData.addons.push({
        name: name,
        options: [{
          name: 'None',
          price: 0
        }]
      });
      // Ensure the edit state array is the correct length
      businessCardEditState.addons = businessCardData.addons.map(() => false);
      renderBusinessCardSettingsTable();
    }

    function removeBusinessCardAddonType(addonIndex) {
      const addonName = businessCardData.addons[addonIndex].name;
      if (confirm(`Are you sure you want to delete the entire '${addonName}' add-on type?`)) {
        businessCardData.addons.splice(addonIndex, 1);
        businessCardEditState.addons.splice(addonIndex, 1);
        renderBusinessCardSettingsTable();
      }
    }

    function addBusinessCardAddonOption(addonIndex) {
      const name = prompt(`Enter new option name for ${businessCardData.addons[addonIndex].name}:`);
      if (!name) return;
      const price = parseFloat(prompt(`Enter price for ${name}:`));
      if (isNaN(price)) {
        alert("Invalid price.");
        return;
      }
      const newOption = {
        price: price
      };
      // Check if this addon type uses 'label'/'value' or 'name'
      if (businessCardData.addons[addonIndex].options[0].hasOwnProperty('label')) {
        newOption.label = name;
        newOption.value = name.toLowerCase().replace(/\s+/g, '');
      } else {
        newOption.name = name;
      }
      businessCardData.addons[addonIndex].options.push(newOption);
      renderBusinessCardSettingsTable();
    }

    function removeBusinessCardAddonOption(addonIndex, optionIndex) {
      const addon = businessCardData.addons[addonIndex];
      const option = addon.options[optionIndex];
      if (confirm(`Are you sure you want to remove the option '${option.name || option.label}' from '${addon.name}'?`)) {
        addon.options.splice(optionIndex, 1);
        renderBusinessCardSettingsTable();
      }
    }

    function resetForm() {
      const materialName = document.getElementById("materialName");
      const customerPrice = document.getElementById("customerPrice");
      const agentPrice = document.getElementById("agentPrice");
      const isSimpleCheckbox = document.getElementById("isSimple");
      if (materialName) materialName.value = "";
      if (customerPrice) customerPrice.value = "";
      if (agentPrice) agentPrice.value = "";
      if (isSimpleCheckbox) isSimpleCheckbox.checked = false;
      editingIndex = -1;
      const formTitle = document.getElementById("formTitle");
      const saveButtonLabel = document.getElementById("saveButtonLabel");
      if (formTitle) formTitle.innerText = "Add New Material";
      if (saveButtonLabel) saveButtonLabel.innerText = "Add Material";
    }

    function saveMaterial() {
      const name = document.getElementById("materialName").value.trim();
      const cust = parseFloat(document.getElementById("customerPrice").value);
      const agent = parseFloat(document.getElementById("agentPrice").value);
      if (name === "" || isNaN(cust) || isNaN(agent)) {
        alert("Please fill all fields.");
        return;
      }
      let newItem = {
        name,
        customerPrice: cust,
        agentPrice: agent,
        agent: false
      };
      const category = document.getElementById("categorySelect").value;
      if (category === "largeFormat" || category === "signboard") {
        newItem.simple = document.getElementById("isSimple").checked;
      }
      let arr = getCategoryArray();
      if (editingIndex >= 0) {
        arr[editingIndex] = newItem;
      } else {
        arr.push(newItem);
      }
      updateSettingsTable();
      resetForm();
    }

    function editMaterial(index) {
      const arr = getCategoryArray();
      const item = arr[index];
      document.getElementById("materialName").value = item.name;
      document.getElementById("customerPrice").value = item.customerPrice;
      document.getElementById("agentPrice").value = item.agentPrice;
      const category = document.getElementById("categorySelect").value;
      if (category === "largeFormat" || category === "signboard") {
        document.getElementById("isSimple").checked = item.simple;
      }
      editingIndex = index;
      document.getElementById("formTitle").innerText = "Edit Material";
      document.getElementById("saveButtonLabel").innerText = "Save Changes";
      document.getElementById("materialName").focus();
    }

    function deleteMaterial(index) {
      if (confirm("Are you sure?")) {
        let arr = getCategoryArray();
        arr.splice(index, 1);
        updateSettingsTable();
      }
    }
    document.addEventListener('DOMContentLoaded', () => loadPage('home'));
  </script>

  <script>
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
    const themeToggleBtn = document.getElementById('theme-toggle');
    // Function to update icon state
    const updateIcons = () => {
      if (document.documentElement.classList.contains('dark')) {
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleDarkIcon.classList.add('hidden');
      } else {
        themeToggleLightIcon.classList.add('hidden');
        themeToggleDarkIcon.classList.remove('hidden');
      }
    };
    // Check for saved theme in localStorage on page load
    if (localStorage.getItem('color-theme') === 'light') {
      document.documentElement.classList.remove('dark');
    } else {
      // Default to dark if nothing is saved or it's set to dark
      document.documentElement.classList.add('dark');
    }
    updateIcons(); // Set the initial icon state
    // Add click listener to the toggle button
    themeToggleBtn.addEventListener('click', () => {
      // Toggle the class on the <html> element
      document.documentElement.classList.toggle('dark');
      // Update localStorage with the new theme
      if (document.documentElement.classList.contains('dark')) {
        localStorage.setItem('color-theme', 'dark');
      } else {
        localStorage.setItem('color-theme', 'light');
      }
      updateIcons(); // Update the icon after toggling
    });
  </script>

</body>

</html>
